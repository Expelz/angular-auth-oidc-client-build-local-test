!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/common/http"),require("@angular/core"),require("rxjs"),require("jsrsasign-reduced"),require("rxjs/operators"),require("common-tags"),require("@angular/router"),require("broadcast-channel")):"function"==typeof define&&define.amd?define("angular-auth-oidc-client",["exports","@angular/common","@angular/common/http","@angular/core","rxjs","jsrsasign-reduced","rxjs/operators","common-tags","@angular/router","broadcast-channel"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["angular-auth-oidc-client"]={},e.ng.common,e.ng.common.http,e.ng.core,e.rxjs,e["jsrsasign-reduced"],e.rxjs.operators,e["common-tags"],e.ng.router,e["broadcast-channel"])}(this,(function(e,t,r,n,i,o,s,a,c,l){"use strict";var u=function(){function e(e){this.http=e}return e.prototype.get=function(e,t){return this.http.get(e,t)},e.prototype.post=function(e,t,r){return this.http.post(e,t,r)},e}();u.ɵfac=function(e){return new(e||u)(n.ɵɵinject(r.HttpClient))},u.ɵprov=n.ɵɵdefineInjectable({token:u,factory:u.ɵfac});var h,d=function(){function e(e){this.httpClient=e}return e.prototype.get=function(e,t){var r=this.prepareHeaders(t);return this.httpClient.get(e,{headers:r})},e.prototype.post=function(e,t,r){var n=r||this.prepareHeaders();return this.httpClient.post(e,t,{headers:n})},e.prototype.prepareHeaders=function(e){var t=new r.HttpHeaders;return t=t.set("Accept","application/json"),e&&(t=t.set("Authorization","Bearer "+decodeURIComponent(e))),t},e}();d.ɵfac=function(e){return new(e||d)(n.ɵɵinject(u))},d.ɵprov=n.ɵɵdefineInjectable({token:d,factory:d.ɵfac}),(h=e.EventTypes||(e.EventTypes={}))[h.ConfigLoaded=0]="ConfigLoaded",h[h.ConfigLoadingFailed=1]="ConfigLoadingFailed",h[h.CheckSessionReceived=2]="CheckSessionReceived",h[h.UserDataChanged=3]="UserDataChanged",h[h.NewAuthorizationResult=4]="NewAuthorizationResult",h[h.TokenExpired=5]="TokenExpired",h[h.IdTokenExpired=6]="IdTokenExpired",h[h.SilentRenewFinished=7]="SilentRenewFinished";var g,f=function(){};f.ɵfac=function(e){return new(e||f)},f.ɵprov=n.ɵɵdefineInjectable({token:f,factory:f.ɵfac}),(g=e.LogLevel||(e.LogLevel={}))[g.None=0]="None",g[g.Debug=1]="Debug",g[g.Warn=2]="Warn",g[g.Error=3]="Error";var v={stsServer:"https://please_set",authWellknownEndpoint:"",redirectUrl:"https://please_set",clientId:"please_set",responseType:"code",scope:"openid email profile",hdParam:"",postLogoutRedirectUri:"https://please_set",startCheckSession:!1,silentRenew:!1,silentRenewUrl:"https://please_set",silentRenewTimeoutInSeconds:20,renewTimeBeforeTokenExpiresInSeconds:0,useRefreshToken:!1,ignoreNonceAfterRefresh:!1,postLoginRoute:"/",forbiddenRoute:"/forbidden",unauthorizedRoute:"/unauthorized",autoUserinfo:!0,autoCleanStateAfterAuthentication:!0,triggerAuthorizationResultEvent:!1,logLevel:e.LogLevel.Warn,issValidationOff:!1,historyCleanupOff:!1,maxIdTokenIatOffsetAllowedInSeconds:120,disableIatOffsetValidation:!1,storage:"undefined"!=typeof Storage?sessionStorage:null,customParams:{},eagerLoadAuthWellKnownEndpoints:!0,disableRefreshIdTokenAuthTimeValidation:!1,tokenRefreshInSeconds:4},p=function(){function e(e){this.platformId=e}return Object.defineProperty(e.prototype,"isBrowser",{get:function(){return t.isPlatformBrowser(this.platformId)},enumerable:!1,configurable:!0}),e}();p.ɵfac=function(e){return new(e||p)(n.ɵɵinject(n.PLATFORM_ID))},p.ɵprov=n.ɵɵdefineInjectable({token:p,factory:p.ɵfac});var S=function(){function e(e){this.platformProvider=e}return Object.defineProperty(e.prototype,"openIDConfiguration",{get:function(){return this.openIdConfigurationInternal||null},enumerable:!1,configurable:!0}),e.prototype.hasValidConfig=function(){return!!this.openIdConfigurationInternal},e.prototype.setConfig=function(e){return this.openIdConfigurationInternal=Object.assign(Object.assign({},v),e),(null==e?void 0:e.storage)&&console.warn("PLEASE NOTE: The storage in the config will be deprecated in future versions:\n                Please pass the custom storage in forRoot() as documented"),this.setSpecialCases(this.openIdConfigurationInternal),this.openIdConfigurationInternal},e.prototype.setSpecialCases=function(e){this.platformProvider.isBrowser||(e.startCheckSession=!1,e.silentRenew=!1,e.useRefreshToken=!1)},e}();S.ɵfac=function(e){return new(e||S)(n.ɵɵinject(p))},S.ɵprov=n.ɵɵdefineInjectable({token:S,factory:S.ɵfac});var w=function(){function e(e,t){this.oidcSecurityStorage=e,this.configurationProvider=t}return e.prototype.read=function(e){var t=this.createKeyWithPrefix(e);return this.oidcSecurityStorage.read(t)},e.prototype.write=function(e,t){var r=this.createKeyWithPrefix(e);this.oidcSecurityStorage.write(r,t)},e.prototype.remove=function(e){var t=this.createKeyWithPrefix(e);this.oidcSecurityStorage.remove(t)},e.prototype.resetStorageFlowData=function(){this.remove("session_state"),this.remove("storageSilentRenewRunning"),this.remove("codeVerifier"),this.remove("userData"),this.remove("storageCustomRequestParams")},e.prototype.resetAuthStateInStorage=function(){this.remove("authzData"),this.remove("authnResult")},e.prototype.getAccessToken=function(){return this.read("authzData")},e.prototype.getIdToken=function(){var e;return null===(e=this.read("authnResult"))||void 0===e?void 0:e.id_token},e.prototype.getRefreshToken=function(){var e;return null===(e=this.read("authnResult"))||void 0===e?void 0:e.refresh_token},e.prototype.createKeyWithPrefix=function(e){var t;return((null===(t=this.configurationProvider.openIDConfiguration)||void 0===t?void 0:t.clientId)||"")+"_"+e},e}();w.ɵfac=function(e){return new(e||w)(n.ɵɵinject(f),n.ɵɵinject(S))},w.ɵprov=n.ɵɵdefineInjectable({token:w,factory:w.ɵfac});Object.create;function k(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function y(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s}function I(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(y(arguments[t]));return e}function R(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}Object.create;var b=function(){function t(e){this.configurationProvider=e}return t.prototype.logError=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.loggingIsTurnedOff()||(t&&t.length?console.error.apply(console,I([e],t)):console.error(e))},t.prototype.logWarning=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.logLevelIsSet()&&(this.loggingIsTurnedOff()||this.currentLogLevelIsEqualOrSmallerThan(e.LogLevel.Warn)&&(r&&r.length?console.warn.apply(console,I([t],r)):console.warn(t)))},t.prototype.logDebug=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.logLevelIsSet()&&(this.loggingIsTurnedOff()||this.currentLogLevelIsEqualOrSmallerThan(e.LogLevel.Debug)&&(r&&r.length?console.log.apply(console,I([t],r)):console.log(t)))},t.prototype.currentLogLevelIsEqualOrSmallerThan=function(e){return this.configurationProvider.openIDConfiguration.logLevel<=e},t.prototype.logLevelIsSet=function(){var e=(this.configurationProvider.openIDConfiguration||{}).logLevel;return null!==e&&void 0!==e},t.prototype.loggingIsTurnedOff=function(){var t;return(null===(t=this.configurationProvider.openIDConfiguration)||void 0===t?void 0:t.logLevel)===e.LogLevel.None},t}();b.ɵfac=function(e){return new(e||b)(n.ɵɵinject(S))},b.ɵprov=n.ɵɵdefineInjectable({token:b,factory:b.ɵfac});var m=function(){function e(){this.notify=new i.ReplaySubject(1)}return e.prototype.fireEvent=function(e,t){this.notify.next({type:e,value:t})},e.prototype.registerForEvents=function(){return this.notify.asObservable()},e}();m.ɵfac=function(e){return new(e||m)},m.ɵprov=n.ɵɵdefineInjectable({token:m,factory:m.ɵfac});var E=function(){function e(e){this.loggerService=e}return e.prototype.getTokenExpirationDate=function(e){if(!e.hasOwnProperty("exp"))return new Date((new Date).toUTCString());var t=new Date(0);return t.setUTCSeconds(e.exp),t},e.prototype.getHeaderFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,0,t):{}},e.prototype.getPayloadFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,1,t):{}},e.prototype.getSignatureFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,2,t):{}},e.prototype.getPartOfToken=function(e,t,r){var n=this.extractPartOfToken(e,t);if(r)return n;var i=this.urlBase64Decode(n);return JSON.parse(i)},e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("Illegal base64url string!")}var r="undefined"!=typeof window?window.atob(t):Buffer.from(t,"base64").toString("binary");try{return decodeURIComponent(r.split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}catch(e){return r}},e.prototype.tokenIsValid=function(e){return e?e.includes(".")?3===e.split(".").length||(this.loggerService.logError("token '"+e+"' is not valid --\x3e token has to have exactly 2 dots"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e no dots included"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e token falsy"),!1)},e.prototype.extractPartOfToken=function(e,t){return e.split(".")[t]},e}();E.ɵfac=function(e){return new(e||E)(n.ɵɵinject(b))},E.ɵprov=n.ɵɵdefineInjectable({token:E,factory:E.ɵfac});var C=function(){function e(e){this.configurationProvider=e}return e.prototype.isCurrentFlowCodeFlow=function(){return this.currentFlowIs("code")},e.prototype.isCurrentFlowAnyImplicitFlow=function(){return this.isCurrentFlowImplicitFlowWithAccessToken()||this.isCurrentFlowImplicitFlowWithoutAccessToken()},e.prototype.isCurrentFlowCodeFlowWithRefreshTokens=function(){return!(!this.isCurrentFlowCodeFlow()||!this.configurationProvider.openIDConfiguration.useRefreshToken)},e.prototype.isCurrentFlowImplicitFlowWithAccessToken=function(){return this.currentFlowIs("id_token token")},e.prototype.isCurrentFlowImplicitFlowWithoutAccessToken=function(){return this.currentFlowIs("id_token")},e.prototype.currentFlowIs=function(e){var t=this.configurationProvider.openIDConfiguration.responseType;return Array.isArray(e)?e.some((function(e){return t===e})):t===e},e}();C.ɵfac=function(e){return new(e||C)(n.ɵɵinject(S))},C.ɵprov=n.ɵɵdefineInjectable({token:C,factory:C.ɵfac});var T=function(){function e(e,t,r){this.tokenHelperService=e,this.flowHelper=t,this.loggerService=r,this.keyAlgorithms=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","PS256","PS384","PS512"]}return e.prototype.hasIdTokenExpired=function(e,t){var r=this.tokenHelperService.getPayloadFromToken(e,!1);return!this.validateIdTokenExpNotExpired(r,t)},e.prototype.validateIdTokenExpNotExpired=function(e,t){var r=this.tokenHelperService.getTokenExpirationDate(e);if(t=t||0,!r)return!1;var n=r.valueOf(),i=new Date((new Date).toUTCString()).valueOf()+1e3*t,o=n>i;return this.loggerService.logDebug("Has id_token expired: "+!o+", "+n+" > "+i),o},e.prototype.validateAccessTokenNotExpired=function(e,t){if(!e)return!0;t=t||0;var r=e.valueOf(),n=new Date((new Date).toUTCString()).valueOf()+1e3*t,i=r>n;return this.loggerService.logDebug("Has access_token expired: "+!i+", "+r+" > "+n),i},e.prototype.validateRequiredIdToken=function(e){var t=!0;return e.hasOwnProperty("iss")||(t=!1,this.loggerService.logWarning("iss is missing, this is required in the id_token")),e.hasOwnProperty("sub")||(t=!1,this.loggerService.logWarning("sub is missing, this is required in the id_token")),e.hasOwnProperty("aud")||(t=!1,this.loggerService.logWarning("aud is missing, this is required in the id_token")),e.hasOwnProperty("exp")||(t=!1,this.loggerService.logWarning("exp is missing, this is required in the id_token")),e.hasOwnProperty("iat")||(t=!1,this.loggerService.logWarning("iat is missing, this is required in the id_token")),t},e.prototype.validateIdTokenIatMaxOffset=function(e,t,r){if(r)return!0;if(!e.hasOwnProperty("iat"))return!1;var n=new Date(0);n.setUTCSeconds(e.iat),t=t||0;var i=new Date((new Date).toUTCString()).valueOf()-n.valueOf(),o=1e3*t;return this.loggerService.logDebug("validate id token iat max offset "+i+" < "+o),i>0?i<o:-i<o},e.prototype.validateIdTokenNonce=function(t,r,n){return!((void 0!==t.nonce&&!n||r!==e.refreshTokenNoncePlaceholder)&&t.nonce!==r)||(this.loggerService.logDebug("Validate_id_token_nonce failed, dataIdToken.nonce: "+t.nonce+" local_nonce:"+r),!1)},e.prototype.validateIdTokenIss=function(e,t){return e.iss===t||(this.loggerService.logDebug("Validate_id_token_iss failed, dataIdToken.iss: "+e.iss+" authWellKnownEndpoints issuer:"+t),!1)},e.prototype.validateIdTokenAud=function(e,t){return Array.isArray(e.aud)?!!e.aud.includes(t)||(this.loggerService.logDebug("Validate_id_token_aud array failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):e.aud===t||(this.loggerService.logDebug("Validate_id_token_aud failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1)},e.prototype.validateIdTokenAzpExistsIfMoreThanOneAud=function(e){return!!e&&!(Array.isArray(e.aud)&&e.aud.length>1&&!e.azp)},e.prototype.validateIdTokenAzpValid=function(e,t){return!(null==e?void 0:e.azp)||e.azp===t},e.prototype.validateStateFromHashCallback=function(e,t){return e===t||(this.loggerService.logDebug("ValidateStateFromHashCallback failed, state: "+e+" local_state:"+t),!1)},e.prototype.validateSignatureIdToken=function(e,t){var r,n,i,s,a,c;if(!t||!t.keys)return!1;var l=this.tokenHelperService.getHeaderFromToken(e,!1);if(0===Object.keys(l).length&&l.constructor===Object)return this.loggerService.logWarning("id token has no header data"),!1;var u=l.kid,h=l.alg;if(!this.keyAlgorithms.includes(h))return this.loggerService.logWarning("alg not supported",h),!1;var d="RSA";"E"===h.charAt(0)&&(d="EC");var g=!1;if(l.hasOwnProperty("kid"))try{for(var f=k(t.keys),v=f.next();!v.done;v=f.next()){if((b=v.value).kid===u){var p=o.KEYUTIL.getKey(b);return(g=o.KJUR.jws.JWS.verify(e,p,[h]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),g}}}catch(e){a={error:e}}finally{try{v&&!v.done&&(c=f.return)&&c.call(f)}finally{if(a)throw a.error}}else{var S=0;try{for(var w=k(t.keys),y=w.next();!y.done;y=w.next()){(b=y.value).kty===d&&"sig"===b.use&&(S+=1)}}catch(e){r={error:e}}finally{try{y&&!y.done&&(n=w.return)&&n.call(w)}finally{if(r)throw r.error}}if(0===S)return this.loggerService.logWarning("no keys found, incorrect Signature, validation failed for id_token"),!1;if(S>1)return this.loggerService.logWarning("no ID Token kid claim in JOSE header and multiple supplied in jwks_uri"),!1;try{for(var I=k(t.keys),R=I.next();!R.done;R=I.next()){var b;if((b=R.value).kty===d&&"sig"===b.use){var m=o.KEYUTIL.getKey(b);return(g=o.KJUR.jws.JWS.verify(e,m,[h]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),g}}}catch(e){i={error:e}}finally{try{R&&!R.done&&(s=I.return)&&s.call(I)}finally{if(i)throw i.error}}}return g},e.prototype.hasConfigValidResponseType=function(){return!!this.flowHelper.isCurrentFlowAnyImplicitFlow()||(!!this.flowHelper.isCurrentFlowCodeFlow()||(this.loggerService.logWarning("module configured incorrectly, invalid response_type. Check the responseType in the config"),!1))},e.prototype.validateIdTokenAtHash=function(e,t,r){this.loggerService.logDebug("at_hash from the server:"+t);var n="sha256";r.includes("384")?n="sha384":r.includes("512")&&(n="sha512");var i=this.generateAtHash(""+e,n);if(this.loggerService.logDebug("at_hash client validation not decoded:"+i),i===t)return!0;var o=this.generateAtHash(""+decodeURIComponent(e),n);return this.loggerService.logDebug("-gen access--"+o),o===t},e.prototype.generateCodeChallenge=function(e){var t=o.KJUR.crypto.Util.hashString(e,"sha256");return o.hextob64u(t)},e.prototype.generateAtHash=function(e,t){var r=o.KJUR.crypto.Util.hashString(e,t),n=r.substr(0,r.length/2);return o.hextob64u(n)},e}();T.refreshTokenNoncePlaceholder="--RefreshToken--",T.ɵfac=function(e){return new(e||T)(n.ɵɵinject(E),n.ɵɵinject(C),n.ɵɵinject(b))},T.ɵprov=n.ɵɵdefineInjectable({token:T,factory:T.ɵfac});var D=function(){function t(e,t,r,n,o){this.storagePersistanceService=e,this.loggerService=t,this.publicEventsService=r,this.configurationProvider=n,this.tokenValidationService=o,this.authorizedInternal$=new i.BehaviorSubject(!1)}return Object.defineProperty(t.prototype,"authorized$",{get:function(){return this.authorizedInternal$.asObservable()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isAuthorized",{get:function(){return!!this.storagePersistanceService.getAccessToken()&&!!this.storagePersistanceService.getIdToken()},enumerable:!1,configurable:!0}),t.prototype.setAuthorizedAndFireEvent=function(){this.authorizedInternal$.next(!0)},t.prototype.setUnauthorizedAndFireEvent=function(){this.storagePersistanceService.resetAuthStateInStorage(),this.authorizedInternal$.next(!1)},t.prototype.updateAndPublishAuthState=function(t){this.publicEventsService.fireEvent(e.EventTypes.NewAuthorizationResult,t)},t.prototype.setAuthorizationData=function(e,t){this.loggerService.logDebug(e),this.loggerService.logDebug("storing the accessToken"),this.storagePersistanceService.write("authzData",e),this.persistAccessTokenExpirationTime(t),this.setAuthorizedAndFireEvent()},t.prototype.getAccessToken=function(){if(!this.isAuthorized)return"";var e=this.storagePersistanceService.getAccessToken();return this.decodeURIComponentSafely(e)},t.prototype.getIdToken=function(){if(!this.isAuthorized)return"";var e=this.storagePersistanceService.getIdToken();return this.decodeURIComponentSafely(e)},t.prototype.getRefreshToken=function(){if(!this.isAuthorized)return"";var e=this.storagePersistanceService.getRefreshToken();return this.decodeURIComponentSafely(e)},t.prototype.areAuthStorageTokensValid=function(){return!!this.isAuthorized&&(this.hasIdTokenExpired()?(this.loggerService.logDebug("persisted id_token is expired"),!1):this.hasAccessTokenExpiredIfExpiryExists()?(this.loggerService.logDebug("persisted access_token is expired"),!1):(this.loggerService.logDebug("persisted id_token and access token are valid"),!0))},t.prototype.hasIdTokenExpired=function(){var t=this.storagePersistanceService.getIdToken(),r=this.tokenValidationService.hasIdTokenExpired(t,this.configurationProvider.openIDConfiguration.renewTimeBeforeTokenExpiresInSeconds);return r&&this.publicEventsService.fireEvent(e.EventTypes.IdTokenExpired,r),r},t.prototype.hasAccessTokenExpiredIfExpiryExists=function(){var t=this.storagePersistanceService.read("access_token_expires_at"),r=!this.tokenValidationService.validateAccessTokenNotExpired(t,this.configurationProvider.openIDConfiguration.renewTimeBeforeTokenExpiresInSeconds);return r&&this.publicEventsService.fireEvent(e.EventTypes.TokenExpired,r),r},t.prototype.decodeURIComponentSafely=function(e){return e?decodeURIComponent(e):""},t.prototype.persistAccessTokenExpirationTime=function(e){if(null==e?void 0:e.expires_in){var t=new Date((new Date).toUTCString()).valueOf()+1e3*e.expires_in;this.storagePersistanceService.write("access_token_expires_at",t)}},t}();D.ɵfac=function(e){return new(e||D)(n.ɵɵinject(w),n.ɵɵinject(b),n.ɵɵinject(m),n.ɵɵinject(S),n.ɵɵinject(T))},D.ɵprov=n.ɵɵdefineInjectable({token:D,factory:D.ɵfac});var P=function(){function e(e,t){this.doc=e,this.loggerService=t}return e.prototype.getExistingIFrame=function(e){var t=this.getIFrameFromParentWindow(e);if(this.isIFrameElement(t))return t;var r=this.getIFrameFromWindow(e);return this.isIFrameElement(r)?r:null},e.prototype.addIFrameToWindowBody=function(e){var t=this.doc.createElement("iframe");return t.id=e,t.title=e,this.loggerService.logDebug(t),t.style.display="none",this.doc.body.appendChild(t),t},e.prototype.getIFrameFromParentWindow=function(e){try{var t=this.doc.defaultView.parent.document.getElementById(e);return this.isIFrameElement(t)?t:null}catch(e){return null}},e.prototype.getIFrameFromWindow=function(e){var t=this.doc.getElementById(e);return this.isIFrameElement(t)?t:null},e.prototype.isIFrameElement=function(e){return!!e&&e instanceof HTMLIFrameElement},e}();P.ɵfac=function(e){return new(e||P)(n.ɵɵinject(t.DOCUMENT),n.ɵɵinject(b))},P.ɵprov=n.ɵɵdefineInjectable({token:P,factory:P.ɵfac});var A,j,F="myiFrameForCheckSession",U=function(){function t(e,t,r,n,o,s){this.storagePersistanceService=e,this.loggerService=t,this.iFrameService=r,this.eventService=n,this.configurationProvider=o,this.zone=s,this.checkSessionReceived=!1,this.lastIFrameRefresh=0,this.outstandingMessages=0,this.heartBeatInterval=3e3,this.iframeRefreshInterval=6e4,this.checkSessionChangedInternal$=new i.BehaviorSubject(!1)}return Object.defineProperty(t.prototype,"checkSessionChanged$",{get:function(){return this.checkSessionChangedInternal$.asObservable()},enumerable:!1,configurable:!0}),t.prototype.isCheckSessionConfigured=function(){return this.configurationProvider.openIDConfiguration.startCheckSession},t.prototype.start=function(){if(!this.scheduledHeartBeatRunning){var e=this.configurationProvider.openIDConfiguration.clientId;this.pollServerSession(e)}},t.prototype.stop=function(){this.scheduledHeartBeatRunning&&(this.clearScheduledHeartBeat(),this.checkSessionReceived=!1)},t.prototype.serverStateChanged=function(){return this.configurationProvider.openIDConfiguration.startCheckSession&&this.checkSessionReceived},t.prototype.getExistingIframe=function(){return this.iFrameService.getExistingIFrame(F)},t.prototype.init=function(){var e=this;if(this.lastIFrameRefresh+this.iframeRefreshInterval>Date.now())return i.of(void 0);var t=this.storagePersistanceService.read("authWellKnownEndPoints");if(!t)return this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined. Returning."),i.of();var r=this.getOrCreateIframe(),n=t.checkSessionIframe;return n?r.contentWindow.location.replace(n):this.loggerService.logWarning("init check session: checkSessionIframe is not configured to run"),new i.Observable((function(t){r.onload=function(){e.lastIFrameRefresh=Date.now(),t.next(),t.complete()}}))},t.prototype.pollServerSession=function(e){var t=this;this.outstandingMessages=0;var r=function(){t.init().pipe(s.take(1)).subscribe((function(){var n,i=t.getExistingIframe();if(i&&e){t.loggerService.logDebug(i);var o=t.storagePersistanceService.read("session_state"),s=t.storagePersistanceService.read("authWellKnownEndPoints");if(o&&(null==s?void 0:s.checkSessionIframe)){var a=null===(n=new URL(s.checkSessionIframe))||void 0===n?void 0:n.origin;t.outstandingMessages++,i.contentWindow.postMessage(e+" "+o,a)}else t.loggerService.logDebug("OidcSecurityCheckSession pollServerSession session_state is '"+o+"'"),t.loggerService.logDebug("AuthWellKnownEndPoints is '"+JSON.stringify(s)+"'"),t.checkSessionChangedInternal$.next(!0)}else t.loggerService.logWarning("OidcSecurityCheckSession pollServerSession checkSession IFrame does not exist"),t.loggerService.logDebug(e),t.loggerService.logDebug(i);t.outstandingMessages>3&&t.loggerService.logError("OidcSecurityCheckSession not receiving check session response messages.\n                            Outstanding messages: "+t.outstandingMessages+". Server unreachable?"),t.zone.runOutsideAngular((function(){t.scheduledHeartBeatRunning=setTimeout((function(){return t.zone.run(r)}),t.heartBeatInterval)}))}))};r()},t.prototype.clearScheduledHeartBeat=function(){clearTimeout(this.scheduledHeartBeatRunning),this.scheduledHeartBeatRunning=null},t.prototype.messageHandler=function(t){var r,n=this.getExistingIframe(),i=this.storagePersistanceService.read("authWellKnownEndPoints"),o=!!(null===(r=null==i?void 0:i.checkSessionIframe)||void 0===r?void 0:r.startsWith(t.origin));this.outstandingMessages=0,n&&o&&t.source===n.contentWindow&&("error"===t.data?this.loggerService.logWarning("error from checksession messageHandler"):"changed"===t.data?(this.loggerService.logDebug(t),this.checkSessionReceived=!0,this.eventService.fireEvent(e.EventTypes.CheckSessionReceived,t.data),this.checkSessionChangedInternal$.next(!0)):(this.eventService.fireEvent(e.EventTypes.CheckSessionReceived,t.data),this.loggerService.logDebug(t.data+" from checksession messageHandler")))},t.prototype.bindMessageEventToIframe=function(){var e=this.messageHandler.bind(this);window.addEventListener("message",e,!1)},t.prototype.getOrCreateIframe=function(){var e=this.getExistingIframe();if(!e){var t=this.iFrameService.addIFrameToWindowBody(F);return this.bindMessageEventToIframe(),t}return e},t}();U.ɵfac=function(e){return new(e||U)(n.ɵɵinject(w),n.ɵɵinject(b),n.ɵɵinject(P),n.ɵɵinject(m),n.ɵɵinject(S),n.ɵɵinject(n.NgZone))},U.ɵprov=n.ɵɵdefineInjectable({token:U,factory:U.ɵfac}),(A=e.AuthorizedState||(e.AuthorizedState={})).Authorized="Authorized",A.Unauthorized="Unauthorized",A.Unknown="Unknown",(j=e.ValidationResult||(e.ValidationResult={})).NotSet="NotSet",j.StatesDoNotMatch="StatesDoNotMatch",j.SignatureFailed="SignatureFailed",j.IncorrectNonce="IncorrectNonce",j.RequiredPropertyMissing="RequiredPropertyMissing",j.MaxOffsetExpired="MaxOffsetExpired",j.IssDoesNotMatchIssuer="IssDoesNotMatchIssuer",j.NoAuthWellKnownEndPoints="NoAuthWellKnownEndPoints",j.IncorrectAud="IncorrectAud",j.IncorrectIdTokenClaimsAfterRefresh="IncorrectIdTokenClaimsAfterRefresh",j.IncorrectAzp="IncorrectAzp",j.TokenExpired="TokenExpired",j.IncorrectAtHash="IncorrectAtHash",j.Ok="Ok",j.LoginRequired="LoginRequired",j.SecureTokenServerError="SecureTokenServerError";var W=function(){function e(){}return e.prototype.encodeKey=function(e){return encodeURIComponent(e)},e.prototype.encodeValue=function(e){return encodeURIComponent(e)},e.prototype.decodeKey=function(e){return decodeURIComponent(e)},e.prototype.decodeValue=function(e){return decodeURIComponent(e)},e}(),O=function(){function e(e,t){this.doc=e,this.loggerService=t}return e.prototype.createRandom=function(e){if(e<=0)return"";e>0&&e<7&&(this.loggerService.logWarning("RandomService called with "+e+" but 7 chars is the minimum, returning 10 chars"),e=10);var t=e-6,r=new Uint8Array((t||t)/2);return this.getCrypto()&&this.getCrypto().getRandomValues(r),Array.from(r,this.toHex).join("")+this.randomString(7)},e.prototype.toHex=function(e){return("0"+e.toString(16)).substr(-2)},e.prototype.randomString=function(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=new Uint32Array(e);if(this.getCrypto()){this.getCrypto().getRandomValues(n);for(var i=0;i<e;i++)t+=r[n[i]%r.length]}return t},e.prototype.getCrypto=function(){return this.doc.defaultView.crypto||this.doc.defaultView.msCrypto},e}();O.ɵfac=function(e){return new(e||O)(n.ɵɵinject(t.DOCUMENT),n.ɵɵinject(b))},O.ɵprov=n.ɵɵdefineInjectable({token:O,factory:O.ɵfac});var _=function(){function e(e,t,r,n){this.storagePersistanceService=e,this.randomService=t,this.configurationProvider=r,this.loggerService=n}return e.prototype.createNonce=function(){var e=this.randomService.createRandom(40);return this.setNonce(e),e},e.prototype.setNonce=function(e){this.storagePersistanceService.write("authNonce",e)},e.prototype.getAuthStateControl=function(){var e=this.storagePersistanceService.read("authStateControl"),t=e?JSON.parse(e):null;if(this.loggerService.logDebug("getAuthStateControl > currentTime: "+(new Date).toTimeString()),t){var r=Date.parse(t.dateOfLaunchedProcessUtc),n=Date.parse((new Date).toISOString());return Math.abs(n-r)>1e3*this.configurationProvider.openIDConfiguration.silentRenewTimeoutInSeconds?(this.loggerService.logWarning("getAuthStateControl -> silent renew process is probably stuck, AuthState will be reset."),this.storagePersistanceService.write("authStateControl",""),!1):(this.loggerService.logDebug("getAuthStateControl > STATE SUCCESSFULLY RETURNED "+t.state+" > currentTime: "+(new Date).toTimeString()),t.state)}return this.loggerService.logWarning("getAuthStateControl > storageObject IS NULL RETURN FALSE > currentTime: "+(new Date).toTimeString()),!1},e.prototype.setAuthStateControl=function(e){this.storagePersistanceService.write("authStateControl",e)},e.prototype.getExistingOrCreateAuthStateControl=function(){var e=this.getAuthStateControl();return e||(e=this.createAuthStateControl()),e},e.prototype.createAuthStateControl=function(){var e=this.randomService.createRandom(40),t={state:e,dateOfLaunchedProcessUtc:(new Date).toISOString()};return this.storagePersistanceService.write("authStateControl",JSON.stringify(t)),e},e.prototype.setSessionState=function(e){this.storagePersistanceService.write("session_state",e)},e.prototype.resetStorageFlowData=function(){this.storagePersistanceService.resetStorageFlowData()},e.prototype.getCodeVerifier=function(){return this.storagePersistanceService.read("codeVerifier")},e.prototype.createCodeVerifier=function(){var e=this.randomService.createRandom(67);return this.storagePersistanceService.write("codeVerifier",e),e},e.prototype.setSilentRenewRunning=function(){var e={state:"running",dateOfLaunchedProcessUtc:(new Date).toISOString()};this.storagePersistanceService.write("storageSilentRenewRunning",JSON.stringify(e))},e.prototype.resetSilentRenewRunning=function(){this.storagePersistanceService.write("storageSilentRenewRunning","")},e.prototype.isSilentRenewRunning=function(){var e=this.storagePersistanceService.read("storageSilentRenewRunning"),t=e?JSON.parse(e):null;if(t){var r=Date.parse(t.dateOfLaunchedProcessUtc),n=Date.parse((new Date).toISOString());return Math.abs(n-r)>1e3*this.configurationProvider.openIDConfiguration.silentRenewTimeoutInSeconds?(this.loggerService.logDebug("silent renew process is probably stuck, state will be reset."),this.resetSilentRenewRunning(),!1):(this.loggerService.logDebug("isSilentRenewRunning > currentTime: "+(new Date).toTimeString()),"running"===t.state)}return!1},e}();_.ɵfac=function(e){return new(e||_)(n.ɵɵinject(w),n.ɵɵinject(O),n.ɵɵinject(S),n.ɵɵinject(b))},_.ɵprov=n.ɵɵdefineInjectable({token:_,factory:_.ɵfac});var z,x,V,L,H=["code","state","token","id_token"],N=function(){function e(e,t,r,n,i,o){this.configurationProvider=e,this.loggerService=t,this.flowsDataService=r,this.flowHelper=n,this.tokenValidationService=i,this.storagePersistanceService=o}return e.prototype.getUrlParameter=function(e,t){if(!e)return"";if(!t)return"";t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e);return null===r?"":decodeURIComponent(r[1])},e.prototype.isCallbackFromSts=function(e){var t=this;return H.some((function(r){return!!t.getUrlParameter(e,r)}))},e.prototype.getRefreshSessionSilentRenewUrl=function(e){return this.flowHelper.isCurrentFlowCodeFlow()?this.createUrlCodeFlowWithSilentRenew(e):this.createUrlImplicitFlowWithSilentRenew(e)||""},e.prototype.getAuthorizeUrl=function(e){return this.flowHelper.isCurrentFlowCodeFlow()?this.createUrlCodeFlowAuthorize(e):this.createUrlImplicitFlowAuthorize(e)||""},e.prototype.createEndSessionUrl=function(e){var t=this.storagePersistanceService.read("authWellKnownEndPoints"),n=null==t?void 0:t.endSessionEndpoint;if(!n)return null;var i=n.split("?"),o=i[0],s=new r.HttpParams({fromString:i[1],encoder:new W});s=s.set("id_token_hint",e);var a=this.getPostLogoutRedirectUrl();return a&&(s=s.append("post_logout_redirect_uri",a)),o+"?"+s},e.prototype.createRevocationEndpointBodyAccessToken=function(e){var t=this.getClientId();return t?"client_id="+t+"&token="+e+"&token_type_hint=access_token":null},e.prototype.createRevocationEndpointBodyRefreshToken=function(e){var t=this.getClientId();return t?"client_id="+t+"&token="+e+"&token_type_hint=refresh_token":null},e.prototype.getRevocationEndpointUrl=function(){var e=this.storagePersistanceService.read("authWellKnownEndPoints"),t=null==e?void 0:e.revocationEndpoint;return t?t.split("?")[0]:null},e.prototype.createBodyForCodeFlowCodeRequest=function(e){var t=this.flowsDataService.getCodeVerifier();if(!t)return this.loggerService.logError("CodeVerifier is not set ",t),null;var r=this.getClientId();if(!r)return null;var n=a.oneLineTrim(z||(z=R(["grant_type=authorization_code\n            &client_id=","\n            &code_verifier=","\n            &code=",""],["grant_type=authorization_code\n            &client_id=","\n            &code_verifier=","\n            &code=",""])),r,t,e),i=this.getSilentRenewUrl();if(this.flowsDataService.isSilentRenewRunning()&&i)return a.oneLineTrim(x||(x=R(["","&redirect_uri=",""],["","&redirect_uri=",""])),n,i);var o=this.getRedirectUrl();return o?a.oneLineTrim(V||(V=R(["","&redirect_uri=",""],["","&redirect_uri=",""])),n,o):null},e.prototype.createBodyForCodeFlowRefreshTokensRequest=function(e,t){var r,n,i=this.getClientId();if(!i)return null;var o=a.oneLineTrim(L||(L=R(["grant_type=refresh_token\n            &client_id=","\n            &refresh_token=",""],["grant_type=refresh_token\n            &client_id=","\n            &refresh_token=",""])),i,e);if(t){var s=Object.assign({},t||{});try{for(var c=k(Object.entries(s)),l=c.next();!l.done;l=c.next()){var u=y(l.value,2),h=u[0],d=u[1];o=o.concat("&"+h+"="+d.toString())}}catch(e){r={error:e}}finally{try{l&&!l.done&&(n=c.return)&&n.call(c)}finally{if(r)throw r.error}}}return o},e.prototype.createAuthorizeUrl=function(e,t,n,i,o,s){var a,c,l=this.storagePersistanceService.read("authWellKnownEndPoints"),u=null==l?void 0:l.authorizationEndpoint;if(!u)return this.loggerService.logError("Can not create an authorize url when authorizationEndpoint is '"+u+"'"),null;var h=this.configurationProvider.openIDConfiguration,d=h.clientId,g=h.responseType,f=h.scope,v=h.hdParam,p=h.customParams;if(!d)return this.loggerService.logError("createAuthorizeUrl could not add clientId because it was: ",d),null;if(!g)return this.loggerService.logError("createAuthorizeUrl could not add responseType because it was: ",g),null;if(!f)return this.loggerService.logError("createAuthorizeUrl could not add scope because it was: ",f),null;var S=u.split("?"),w=S[0],I=new r.HttpParams({fromString:S[1],encoder:new W});if(I=(I=(I=(I=(I=(I=I.set("client_id",d)).append("redirect_uri",t)).append("response_type",g)).append("scope",f)).append("nonce",n)).append("state",i),this.flowHelper.isCurrentFlowCodeFlow()&&(I=(I=I.append("code_challenge",e)).append("code_challenge_method","S256")),o&&(I=I.append("prompt",o)),v&&(I=I.append("hd",v)),p||s){var R=Object.assign(Object.assign({},p||{}),s||{});try{for(var b=k(Object.entries(R)),m=b.next();!m.done;m=b.next()){var E=y(m.value,2),C=E[0],T=E[1];I=I.append(C,T.toString())}}catch(e){a={error:e}}finally{try{m&&!m.done&&(c=b.return)&&c.call(b)}finally{if(a)throw a.error}}}return w+"?"+I},e.prototype.createUrlImplicitFlowWithSilentRenew=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce(),n=this.getSilentRenewUrl();return n?(this.loggerService.logDebug("RefreshSession created. adding myautostate: ",t),this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl("",n,r,t,"none",e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null)):null},e.prototype.createUrlCodeFlowWithSilentRenew=function(e){var t=this.flowsDataService.createAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("RefreshSession created. adding myautostate: "+t);var n=this.flowsDataService.createCodeVerifier(),i=this.tokenValidationService.generateCodeChallenge(n),o=this.getSilentRenewUrl();return o?this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl(i,o,r,t,"none",e):(this.loggerService.logWarning("authWellKnownEndpoints is undefined"),null):null},e.prototype.createUrlImplicitFlowAuthorize=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("Authorize created. adding myautostate: "+t);var n=this.getRedirectUrl();return n?this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl("",n,r,t,null,e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null):null},e.prototype.createUrlCodeFlowAuthorize=function(e){var t=this.flowsDataService.createAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("Authorize created. adding myautostate: "+t);var n=this.getRedirectUrl();if(!n)return null;var i=this.flowsDataService.createCodeVerifier(),o=this.tokenValidationService.generateCodeChallenge(i);return this.storagePersistanceService.read("authWellKnownEndPoints")?this.createAuthorizeUrl(o,n,r,t,null,e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null)},e.prototype.getRedirectUrl=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.redirectUrl;return t||(this.loggerService.logError("could not get redirectUrl, was: ",t),null)},e.prototype.getSilentRenewUrl=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.silentRenewUrl;return t||(this.loggerService.logError("could not get silentRenewUrl, was: ",t),null)},e.prototype.getPostLogoutRedirectUrl=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.postLogoutRedirectUri;return t||(this.loggerService.logError("could not get postLogoutRedirectUri, was: ",t),null)},e.prototype.getClientId=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.clientId;return t||(this.loggerService.logError("could not get clientId, was: ",t),null)},e}();N.ɵfac=function(e){return new(e||N)(n.ɵɵinject(S),n.ɵɵinject(b),n.ɵɵinject(_),n.ɵɵinject(C),n.ɵɵinject(T),n.ɵɵinject(w))},N.ɵprov=n.ɵɵdefineInjectable({token:N,factory:N.ɵfac});var M=function(){function e(e,t,r){this.storagePersistanceService=e,this.loggerService=t,this.dataService=r}return e.prototype.getSigningKeys=function(){var e=this.storagePersistanceService.read("authWellKnownEndPoints"),t=null==e?void 0:e.jwksUri;if(!t){var r="getSigningKeys: authWellKnownEndpoints.jwksUri is: '"+t+"'";return this.loggerService.logWarning(r),i.throwError(r)}return this.loggerService.logDebug("Getting signinkeys from ",t),this.dataService.get(t).pipe(s.catchError(this.handleErrorGetSigningKeys))},e.prototype.handleErrorGetSigningKeys=function(e){var t="";if(e instanceof r.HttpResponse){var n=e.body||{},o=JSON.stringify(n);t=(e.status||"")+" - "+(e.statusText||"")+" "+(o||"")}else{var s=e.message;t=s||""+e}return this.loggerService.logError(t),i.throwError(new Error(t))},e}();M.ɵfac=function(e){return new(e||M)(n.ɵɵinject(w),n.ɵɵinject(b),n.ɵɵinject(d))},M.ɵprov=n.ɵɵdefineInjectable({token:M,factory:M.ɵfac});var K=function(){function t(e,t,r,n,o,s,a){this.oidcDataService=e,this.storagePersistanceService=t,this.eventService=r,this.loggerService=n,this.tokenHelperService=o,this.flowHelper=s,this.configurationProvider=a,this.userDataInternal$=new i.BehaviorSubject(null)}return Object.defineProperty(t.prototype,"userData$",{get:function(){return this.userDataInternal$.asObservable()},enumerable:!1,configurable:!0}),t.prototype.getAndPersistUserDataInStore=function(e,t,r){var n=this;void 0===e&&(e=!1),t=t||this.storagePersistanceService.getIdToken(),r=r||this.tokenHelperService.getPayloadFromToken(t,!1);var o=this.getUserDataFromStore(),a=!!o,c=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(),l=this.flowHelper.isCurrentFlowCodeFlow(),u=this.storagePersistanceService.getAccessToken();return c||l?e&&!this.configurationProvider.openIDConfiguration.renewUserInfoAfterTokenRenew&&a?i.of(o):this.getUserDataOidcFlowAndSave(r.sub).pipe(s.switchMap((function(e){return n.loggerService.logDebug("Received user data",e),e?(n.loggerService.logDebug("accessToken",u),i.of(e)):i.throwError("no user data, request failed")}))):(this.loggerService.logDebug("authorizedCallback id_token flow"),this.loggerService.logDebug("accessToken",u),this.setUserDataToStore(r),i.of(r))},t.prototype.getUserDataFromStore=function(){return this.storagePersistanceService.read("userData")||null},t.prototype.publishUserDataIfExists=function(){var t=this.getUserDataFromStore();t&&(this.userDataInternal$.next(t),this.eventService.fireEvent(e.EventTypes.UserDataChanged,t))},t.prototype.setUserDataToStore=function(t){this.storagePersistanceService.write("userData",t),this.userDataInternal$.next(t),this.eventService.fireEvent(e.EventTypes.UserDataChanged,t)},t.prototype.resetUserDataInStore=function(){this.storagePersistanceService.remove("userData"),this.eventService.fireEvent(e.EventTypes.UserDataChanged,null),this.userDataInternal$.next(null)},t.prototype.getUserDataOidcFlowAndSave=function(e){var t=this;return this.getIdentityUserData().pipe(s.map((function(r){return t.validateUserDataSubIdToken(e,null==r?void 0:r.sub)?(t.setUserDataToStore(r),r):(t.loggerService.logWarning("authorizedCallback, User data sub does not match sub in id_token"),t.loggerService.logDebug("authorizedCallback, token(s) validation failed, resetting"),t.resetUserDataInStore(),null)})))},t.prototype.getIdentityUserData=function(){var e=this.storagePersistanceService.getAccessToken(),t=this.storagePersistanceService.read("authWellKnownEndPoints");if(!t)return this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined"),i.throwError("authWellKnownEndpoints is undefined");var r=t.userinfoEndpoint;return r?this.oidcDataService.get(r,e):(this.loggerService.logError("init check session: authWellKnownEndpoints.userinfo_endpoint is undefined; set auto_userinfo = false in config"),i.throwError("authWellKnownEndpoints.userinfo_endpoint is undefined"))},t.prototype.validateUserDataSubIdToken=function(e,t){return!!e&&(!!t&&(e===t||(this.loggerService.logDebug("validateUserDataSubIdToken failed",e,t),!1)))},t}();K.ɵfac=function(e){return new(e||K)(n.ɵɵinject(d),n.ɵɵinject(w),n.ɵɵinject(m),n.ɵɵinject(b),n.ɵɵinject(E),n.ɵɵinject(C),n.ɵɵinject(S))},K.ɵprov=n.ɵɵdefineInjectable({token:K,factory:K.ɵfac});var q=function(t,r,n,i,o){void 0===t&&(t=""),void 0===r&&(r=""),void 0===n&&(n=!1),void 0===i&&(i={}),void 0===o&&(o=e.ValidationResult.NotSet),this.accessToken=t,this.idToken=r,this.authResponseIsValid=n,this.decodedIdToken=i,this.state=o},B=function(){function e(){}return e.prototype.isStringEqualOrNonOrderedArrayEqual=function(e,t){return!this.isNullOrUndefined(e)&&(!this.isNullOrUndefined(t)&&(!this.oneValueIsStringAndTheOtherIsArray(e,t)&&(this.bothValuesAreStrings(e,t)?e===t:!!this.bothValuesAreArrays(e,t)&&this.arraysHaveEqualContent(e,t))))},e.prototype.areEqual=function(e,t){if(!e||!t)return!1;if(this.bothValuesAreArrays(e,t))return this.arraysStrictEqual(e,t);if(this.bothValuesAreStrings(e,t))return e===t;if(this.bothValuesAreObjects(e,t))return JSON.stringify(e).toLowerCase()===JSON.stringify(t).toLowerCase();if(this.oneValueIsStringAndTheOtherIsArray(e,t)){if(Array.isArray(e)&&this.valueIsString(t))return e[0]===t;if(Array.isArray(t)&&this.valueIsString(e))return t[0]===e}},e.prototype.oneValueIsStringAndTheOtherIsArray=function(e,t){return Array.isArray(e)&&this.valueIsString(t)||Array.isArray(t)&&this.valueIsString(e)},e.prototype.bothValuesAreObjects=function(e,t){return this.valueIsObject(e)&&this.valueIsObject(t)},e.prototype.bothValuesAreStrings=function(e,t){return this.valueIsString(e)&&this.valueIsString(t)},e.prototype.bothValuesAreArrays=function(e,t){return Array.isArray(e)&&Array.isArray(t)},e.prototype.valueIsString=function(e){return"string"==typeof e||e instanceof String},e.prototype.valueIsObject=function(e){return"object"==typeof e},e.prototype.arraysStrictEqual=function(e,t){if(e.length!==t.length)return!1;for(var r=e.length;r--;)if(e[r]!==t[r])return!1;return!0},e.prototype.arraysHaveEqualContent=function(e,t){return e.length===t.length&&e.some((function(e){return t.includes(e)}))},e.prototype.isNullOrUndefined=function(e){return null==e},e}();B.ɵfac=function(e){return new(e||B)},B.ɵprov=n.ɵɵdefineInjectable({token:B,factory:B.ɵfac});var $=function(){function t(e,t,r,n,i,o,s,a){this.storagePersistanceService=e,this.tokenValidationService=t,this.tokenHelperService=r,this.loggerService=n,this.configurationProvider=i,this.equalityService=o,this.flowHelper=s,this.flowsDataService=a}return t.prototype.getValidatedStateResult=function(e){return(null==e?void 0:e.authResult.error)?new q("","",!1,{}):this.validateState(e)},t.prototype.validateState=function(t){var r=new q,n=this.flowsDataService.getAuthStateControl();if(!this.tokenValidationService.validateStateFromHashCallback(t.authResult.state,n))return this.loggerService.logWarning("authorizedCallback incorrect state"),r.state=e.ValidationResult.StatesDoNotMatch,this.handleUnsuccessfulValidation(),r;var i=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(),o=this.flowHelper.isCurrentFlowCodeFlow();if((i||o)&&(r.accessToken=t.authResult.access_token),t.authResult.id_token){if(r.idToken=t.authResult.id_token,r.decodedIdToken=this.tokenHelperService.getPayloadFromToken(r.idToken,!1),!this.tokenValidationService.validateSignatureIdToken(r.idToken,t.jwtKeys))return this.loggerService.logDebug("authorizedCallback Signature validation failed id_token"),r.state=e.ValidationResult.SignatureFailed,this.handleUnsuccessfulValidation(),r;var s=this.storagePersistanceService.read("authNonce");if(!this.tokenValidationService.validateIdTokenNonce(r.decodedIdToken,s,this.configurationProvider.openIDConfiguration.ignoreNonceAfterRefresh))return this.loggerService.logWarning("authorizedCallback incorrect nonce"),r.state=e.ValidationResult.IncorrectNonce,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateRequiredIdToken(r.decodedIdToken))return this.loggerService.logDebug("authorizedCallback Validation, one of the REQUIRED properties missing from id_token"),r.state=e.ValidationResult.RequiredPropertyMissing,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenIatMaxOffset(r.decodedIdToken,this.configurationProvider.openIDConfiguration.maxIdTokenIatOffsetAllowedInSeconds,this.configurationProvider.openIDConfiguration.disableIatOffsetValidation))return this.loggerService.logWarning("authorizedCallback Validation, iat rejected id_token was issued too far away from the current time"),r.state=e.ValidationResult.MaxOffsetExpired,this.handleUnsuccessfulValidation(),r;var a=this.storagePersistanceService.read("authWellKnownEndPoints");if(!a)return this.loggerService.logWarning("authWellKnownEndpoints is undefined"),r.state=e.ValidationResult.NoAuthWellKnownEndPoints,this.handleUnsuccessfulValidation(),r;if(this.configurationProvider.openIDConfiguration.issValidationOff)this.loggerService.logDebug("iss validation is turned off, this is not recommended!");else if(!this.configurationProvider.openIDConfiguration.issValidationOff&&!this.tokenValidationService.validateIdTokenIss(r.decodedIdToken,a.issuer))return this.loggerService.logWarning("authorizedCallback incorrect iss does not match authWellKnownEndpoints issuer"),r.state=e.ValidationResult.IssDoesNotMatchIssuer,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAud(r.decodedIdToken,this.configurationProvider.openIDConfiguration.clientId))return this.loggerService.logWarning("authorizedCallback incorrect aud"),r.state=e.ValidationResult.IncorrectAud,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAzpExistsIfMoreThanOneAud(r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback missing azp"),r.state=e.ValidationResult.IncorrectAzp,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAzpValid(r.decodedIdToken,this.configurationProvider.openIDConfiguration.clientId))return this.loggerService.logWarning("authorizedCallback incorrect azp"),r.state=e.ValidationResult.IncorrectAzp,this.handleUnsuccessfulValidation(),r;if(!this.isIdTokenAfterRefreshTokenRequestValid(t,r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback pre, post id_token claims do not match in refresh"),r.state=e.ValidationResult.IncorrectIdTokenClaimsAfterRefresh,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenExpNotExpired(r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback id token expired"),r.state=e.ValidationResult.TokenExpired,this.handleUnsuccessfulValidation(),r}else this.loggerService.logDebug("No id_token found, skipping id_token validation");if(!i&&!o)return r.authResponseIsValid=!0,r.state=e.ValidationResult.Ok,this.handleSuccessfulValidation(),this.handleUnsuccessfulValidation(),r;var c=this.tokenHelperService.getHeaderFromToken(r.idToken,!1);if(o&&!r.decodedIdToken.at_hash)this.loggerService.logDebug("Code Flow active, and no at_hash in the id_token, skipping check!");else if(!this.tokenValidationService.validateIdTokenAtHash(r.accessToken,r.decodedIdToken.at_hash,c.alg)||!r.accessToken)return this.loggerService.logWarning("authorizedCallback incorrect at_hash"),r.state=e.ValidationResult.IncorrectAtHash,this.handleUnsuccessfulValidation(),r;return r.authResponseIsValid=!0,r.state=e.ValidationResult.Ok,this.handleSuccessfulValidation(),r},t.prototype.isIdTokenAfterRefreshTokenRequestValid=function(e,t){if(!this.configurationProvider.openIDConfiguration.useRefreshToken)return!0;if(!e.existingIdToken)return!0;var r=this.tokenHelperService.getPayloadFromToken(e.existingIdToken,!1);return r.iss!==t.iss?(this.loggerService.logDebug("iss do not match: "+r.iss+" "+t.iss),!1):r.azp!==t.azp?(this.loggerService.logDebug("azp do not match: "+r.azp+" "+t.azp),!1):r.sub!==t.sub?(this.loggerService.logDebug("sub do not match: "+r.sub+" "+t.sub),!1):this.equalityService.isStringEqualOrNonOrderedArrayEqual(null==r?void 0:r.aud,null==t?void 0:t.aud)?!!this.configurationProvider.openIDConfiguration.disableRefreshIdTokenAuthTimeValidation||(r.auth_time===t.auth_time||(this.loggerService.logDebug("auth_time do not match: "+r.auth_time+" "+t.auth_time),!1)):(this.loggerService.logDebug("aud in new id_token is not valid: '"+(null==r?void 0:r.aud)+"' '"+t.aud+"'"),!1)},t.prototype.handleSuccessfulValidation=function(){this.storagePersistanceService.write("authNonce",""),this.configurationProvider.openIDConfiguration.autoCleanStateAfterAuthentication&&this.storagePersistanceService.write("authStateControl",""),this.loggerService.logDebug("AuthorizedCallback token(s) validated, continue")},t.prototype.handleUnsuccessfulValidation=function(){this.storagePersistanceService.write("authNonce",""),this.configurationProvider.openIDConfiguration.autoCleanStateAfterAuthentication&&this.storagePersistanceService.write("authStateControl",""),this.loggerService.logDebug("AuthorizedCallback token(s) invalid")},t}();$.ɵfac=function(e){return new(e||$)(n.ɵɵinject(w),n.ɵɵinject(T),n.ɵɵinject(E),n.ɵɵinject(b),n.ɵɵinject(S),n.ɵɵinject(B),n.ɵɵinject(C),n.ɵɵinject(_))},$.ɵprov=n.ɵɵdefineInjectable({token:$,factory:$.ɵfac});var J=function(){function t(e,t,r,n,i,o,s,a,c,l,u){this.urlService=e,this.loggerService=t,this.tokenValidationService=r,this.configurationProvider=n,this.authStateService=i,this.flowsDataService=o,this.signinKeyDataService=s,this.dataService=a,this.userService=c,this.stateValidationService=l,this.storagePersistanceService=u}return t.prototype.resetAuthorizationData=function(){this.configurationProvider.openIDConfiguration.autoUserinfo&&this.userService.resetUserDataInStore(),this.flowsDataService.resetStorageFlowData(),this.authStateService.setUnauthorizedAndFireEvent()},t.prototype.processCodeFlowCallback=function(e){var t=this;return this.codeFlowCallback(e).pipe(s.switchMap((function(e){return t.codeFlowCodeRequest(e)})),s.switchMap((function(e){return t.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.callbackStateValidation(e)})),s.switchMap((function(e){return t.callbackUser(e)})))},t.prototype.processSilentRenewCodeFlowCallback=function(e){var t=this;return this.codeFlowCodeRequest(e).pipe(s.switchMap((function(e){return t.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.callbackStateValidation(e)})),s.switchMap((function(e){return t.callbackUser(e)})))},t.prototype.processImplicitFlowCallback=function(e){var t=this;return this.implicitFlowCallback(e).pipe(s.switchMap((function(e){return t.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.callbackStateValidation(e)})),s.switchMap((function(e){return t.callbackUser(e)})))},t.prototype.processRefreshToken=function(e){var t=this;return this.refreshSessionWithRefreshTokens().pipe(s.switchMap((function(r){return t.refreshTokensRequestTokens(r,e)})),s.switchMap((function(e){return t.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.callbackStateValidation(e)})),s.switchMap((function(e){return t.callbackUser(e)})))},t.prototype.codeFlowCallback=function(e){var t=this.urlService.getUrlParameter(e,"code"),r=this.urlService.getUrlParameter(e,"state"),n=this.urlService.getUrlParameter(e,"session_state")||null;if(!r)return this.loggerService.logDebug("no state in url"),i.throwError("no state in url");if(!t)return this.loggerService.logDebug("no code in url"),i.throwError("no code in url");this.loggerService.logDebug("running validation for callback",e);var o={code:t,refreshToken:null,state:r,sessionState:n,authResult:null,isRenewProcess:!1,jwtKeys:null,validationResult:null,existingIdToken:null};return i.of(o)},t.prototype.implicitFlowCallback=function(e){var t=this.flowsDataService.isSilentRenewRunning();this.loggerService.logDebug("BEGIN authorizedCallback, no auth data"),t||this.resetAuthorizationData();var r={code:null,refreshToken:null,state:null,sessionState:null,authResult:(e=e||window.location.hash.substr(1)).split("&").reduce((function(e,t){var r=t.split("=");return e[r.shift()]=r.join("="),e}),{}),isRenewProcess:t,jwtKeys:null,validationResult:null,existingIdToken:null};return i.of(r)},t.prototype.refreshSessionWithRefreshTokens=function(){var e=this.flowsDataService.getExistingOrCreateAuthStateControl();this.loggerService.logDebug("RefreshSession created. adding myautostate: "+e);var t=this.authStateService.getRefreshToken(),r=this.authStateService.getIdToken();if(t){var n={code:null,refreshToken:t,state:e,sessionState:null,authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:r};return this.loggerService.logDebug("found refresh code, obtaining new credentials with refresh code"),this.flowsDataService.setNonce(T.refreshTokenNoncePlaceholder),i.of(n)}var o="no refresh token found, please login";return this.loggerService.logError(o),i.throwError(o)},t.prototype.refreshTokensRequestTokens=function(e,t){var n=this,o=new r.HttpHeaders;o=o.set("Content-Type","application/x-www-form-urlencoded");var a=this.storagePersistanceService.read("authWellKnownEndPoints"),c=null==a?void 0:a.tokenEndpoint;if(!c)return i.throwError("Token Endpoint not defined");var l=this.urlService.createBodyForCodeFlowRefreshTokensRequest(e.refreshToken,t);return this.dataService.post(c,l,o).pipe(s.switchMap((function(t){n.loggerService.logDebug("token refresh response: ",t);var r=new Object;return(r=t).state=e.state,e.authResult=r,i.of(e)})),s.catchError((function(e){var t="OidcService code request "+n.configurationProvider.openIDConfiguration.stsServer;return n.loggerService.logError(t,e),i.throwError(t)})))},t.prototype.codeFlowCodeRequest=function(e){var t=this;if(!this.tokenValidationService.validateStateFromHashCallback(e.state,this.flowsDataService.getAuthStateControl()))return this.loggerService.logWarning("codeFlowCodeRequest incorrect state"),i.throwError("codeFlowCodeRequest incorrect state");var n=this.storagePersistanceService.read("authWellKnownEndPoints"),o=null==n?void 0:n.tokenEndpoint;if(!o)return i.throwError("Token Endpoint not defined");var a=new r.HttpHeaders;a=a.set("Content-Type","application/x-www-form-urlencoded");var c=this.urlService.createBodyForCodeFlowCodeRequest(e.code);return this.dataService.post(o,c,a).pipe(s.switchMap((function(t){var r=new Object;return(r=t).state=e.state,r.session_state=e.sessionState,e.authResult=r,i.of(e)})),s.catchError((function(e){var r="OidcService code request "+t.configurationProvider.openIDConfiguration.stsServer;return t.loggerService.logError(r,e),i.throwError(r)})))},t.prototype.callbackHistoryAndResetJwtKeys=function(e){var t=this;if(this.storagePersistanceService.write("authnResult",e.authResult),this.historyCleanUpTurnedOn()&&!e.isRenewProcess?this.resetBrowserHistory():this.loggerService.logDebug("history clean up inactive"),e.authResult.error){var r="authorizedCallbackProcedure came with error: "+e.authResult.error;return this.loggerService.logDebug(r),this.resetAuthorizationData(),this.flowsDataService.setNonce(""),this.handleResultErrorFromCallback(e.authResult,e.isRenewProcess),i.throwError(r)}return this.loggerService.logDebug(e.authResult),this.loggerService.logDebug("authorizedCallback created, begin token validation"),this.signinKeyDataService.getSigningKeys().pipe(s.switchMap((function(r){if(r)return e.jwtKeys=r,i.of(e);var n="Failed to retrieve signing key";return t.loggerService.logWarning(n),i.throwError(n)})),s.catchError((function(e){var r="Failed to retrieve signing key with error: "+e;return t.loggerService.logWarning(r),i.throwError(r)})))},t.prototype.callbackStateValidation=function(e){var t=this.stateValidationService.getValidatedStateResult(e);if(e.validationResult=t,t.authResponseIsValid)return this.authStateService.setAuthorizationData(t.accessToken,e.authResult),i.of(e);var r="authorizedCallback, token(s) validation failed, resetting. Hash: "+window.location.hash;return this.loggerService.logWarning(r),this.resetAuthorizationData(),this.publishUnauthorizedState(e.validationResult,e.isRenewProcess),i.throwError(r)},t.prototype.callbackUser=function(e){var t=this;return this.configurationProvider.openIDConfiguration.autoUserinfo?this.userService.getAndPersistUserDataInStore(e.isRenewProcess,e.validationResult.idToken,e.validationResult.decodedIdToken).pipe(s.switchMap((function(r){if(r)return e.refreshToken||t.flowsDataService.setSessionState(e.authResult.session_state),t.publishAuthorizedState(e.validationResult,e.isRenewProcess),i.of(e);t.resetAuthorizationData(),t.publishUnauthorizedState(e.validationResult,e.isRenewProcess);var n="Called for userData but they were "+r;return t.loggerService.logWarning(n),i.throwError(n)})),s.catchError((function(e){var r="Failed to retrieve user info with error:  "+e;return t.loggerService.logWarning(r),i.throwError(r)}))):(e.isRenewProcess||this.userService.setUserDataToStore(e.validationResult.decodedIdToken),this.publishAuthorizedState(e.validationResult,e.isRenewProcess),i.of(e))},t.prototype.publishAuthorizedState=function(t,r){this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Authorized,validationResult:t.state,isRenewProcess:r})},t.prototype.publishUnauthorizedState=function(t,r){this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:t.state,isRenewProcess:r})},t.prototype.handleResultErrorFromCallback=function(t,r){var n=e.ValidationResult.SecureTokenServerError;"login_required"===t.error&&(n=e.ValidationResult.LoginRequired),this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:n,isRenewProcess:r})},t.prototype.historyCleanUpTurnedOn=function(){return!this.configurationProvider.openIDConfiguration.historyCleanupOff},t.prototype.resetBrowserHistory=function(){window.history.replaceState({},window.document.title,window.location.origin+window.location.pathname)},t}();J.ɵfac=function(e){return new(e||J)(n.ɵɵinject(N),n.ɵɵinject(b),n.ɵɵinject(T),n.ɵɵinject(S),n.ɵɵinject(D),n.ɵɵinject(_),n.ɵɵinject(M),n.ɵɵinject(d),n.ɵɵinject(K),n.ɵɵinject($),n.ɵɵinject(w))},J.ɵprov=n.ɵɵdefineInjectable({token:J,factory:J.ɵfac});var G=function(){function e(e){this.zone=e,this.runTokenValidationRunning=null}return e.prototype.stopPeriodicallTokenCheck=function(){this.runTokenValidationRunning&&(this.runTokenValidationRunning.unsubscribe(),this.runTokenValidationRunning=null)},e.prototype.startPeriodicTokenCheck=function(e){var t=this,r=1e3*e;return new i.Observable((function(e){var n;return t.zone.runOutsideAngular((function(){n=setInterval((function(){return e.next()}),r)})),function(){clearInterval(n)}}))},e}();G.ɵfac=function(e){return new(e||G)(n.ɵɵinject(n.NgZone))},G.ɵprov=n.ɵɵdefineInjectable({token:G,factory:G.ɵfac,providedIn:"root"});var Y=function(){function e(e,t,r,n,i){this.flowsService=e,this.configurationProvider=t,this.router=r,this.flowsDataService=n,this.intervallService=i}return e.prototype.authorizedImplicitFlowCallback=function(e){var t=this,r=this.flowsDataService.isSilentRenewRunning();return this.flowsService.processImplicitFlowCallback(e).pipe(s.tap((function(e){t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||e.isRenewProcess||t.router.navigate([t.configurationProvider.openIDConfiguration.postLoginRoute])})),s.catchError((function(e){return t.flowsDataService.resetSilentRenewRunning(),t.intervallService.stopPeriodicallTokenCheck(),t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||r||t.router.navigate([t.configurationProvider.openIDConfiguration.unauthorizedRoute]),i.throwError(e)})))},e}();Y.ɵfac=function(e){return new(e||Y)(n.ɵɵinject(J),n.ɵɵinject(S),n.ɵɵinject(c.Router),n.ɵɵinject(_),n.ɵɵinject(G))},Y.ɵprov=n.ɵɵdefineInjectable({token:Y,factory:Y.ɵfac,providedIn:"root"});var Z=function(){function t(e,t,r){this.configurationProvider=e,this.publicEventsService=t,this.loggerService=r,this._isLeaderSubjectInitialized=!1,this._silentRenewFinished$=new i.ReplaySubject(1),this._leaderSubjectInitialized$=new i.ReplaySubject(1),this._currentRandomId=Math.random().toString(36).substr(2,9)+"_"+(new Date).getUTCMilliseconds(),this.Initialization()}return t.prototype.isLeaderCheck=function(){var e=this;return this.loggerService.logDebug("isLeaderCheck > prefix: "+this._prefix+" > currentRandomId: "+this._currentRandomId),this._isLeaderSubjectInitialized?(this.loggerService.logDebug("isLeaderCheck > IS LEADER IS ALREADY INITIALIZED SUCCESSFULLY> prefix: "+this._prefix+" > currentRandomId: "+this._currentRandomId),new Promise((function(t){setTimeout((function(){var r=e._elector.isLeader;e.loggerService.logWarning("isLeaderCheck > prefix: "+e._prefix+" > currentRandomId: "+e._currentRandomId+" > inside setTimeout isLeader = "+r),t(r)}),1e3)}))):(this.loggerService.logDebug("isLeaderCheck > IS LEADER IS NOT INITIALIZED > prefix: "+this._prefix+" > currentRandomId: "+this._currentRandomId),this._leaderSubjectInitialized$.asObservable().pipe(s.take(1),s.switchMap((function(){return i.of(e._elector.isLeader)}))).toPromise())},t.prototype.getSilentRenewFinishedObservable=function(){return this._silentRenewFinished$.asObservable()},t.prototype.sendSilentRenewFinishedNotification=function(){this._silentRenewFinishedChannel||(this._silentRenewFinishedChannel=new l.BroadcastChannel(this._prefix+"_silent_renew_finished")),this._silentRenewFinishedChannel.postMessage("Silent renew finished by _currentRandomId "+this._currentRandomId)},t.prototype.Initialization=function(){var e,t=this;this.loggerService.logDebug("TabsSynchronizationService > Initialization started"),this._prefix=(null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.clientId)||"";var r=new l.BroadcastChannel(this._prefix+"_leader");this._elector=l.createLeaderElection(r,{fallbackInterval:2e3,responseTime:1e3}),this._elector.awaitLeadership().then((function(){t._isLeaderSubjectInitialized||(t._isLeaderSubjectInitialized=!0,t._leaderSubjectInitialized$.next(!0)),t.loggerService.logDebug("this tab is now leader > prefix: "+t._prefix+" > currentRandomId: "+t._currentRandomId)})),this.initializeSilentRenewFinishedChannelWithHandler()},t.prototype.initializeSilentRenewFinishedChannelWithHandler=function(){var t=this;this._silentRenewFinishedChannel=new l.BroadcastChannel(this._prefix+"_silent_renew_finished"),this._silentRenewFinishedChannel.onmessage=function(){t.loggerService.logDebug("FROM SILENT RENEW FINISHED RECIVED EVENT > prefix: "+t._prefix+" > currentRandomId: "+t._currentRandomId),t._silentRenewFinished$.next(!0),t.publicEventsService.fireEvent(e.EventTypes.SilentRenewFinished,!0)}},t}();Z.ɵfac=function(e){return new(e||Z)(n.ɵɵinject(S),n.ɵɵinject(m),n.ɵɵinject(b))},Z.ɵprov=n.ɵɵdefineInjectable({token:Z,factory:Z.ɵfac});var Q="myiFrameForSilentRenew",X=function(){function t(e,t,r,n,o,s,a,c,l,u){this.configurationProvider=e,this.iFrameService=t,this.flowsService=r,this.flowsDataService=n,this.authStateService=o,this.loggerService=s,this.flowHelper=a,this.implicitFlowCallbackService=c,this.intervallService=l,this.tabsSynchronizationService=u,this.refreshSessionWithIFrameCompletedInternal$=new i.Subject}return Object.defineProperty(t.prototype,"refreshSessionWithIFrameCompleted$",{get:function(){return this.refreshSessionWithIFrameCompletedInternal$.asObservable()},enumerable:!1,configurable:!0}),t.prototype.getOrCreateIframe=function(){var e=this.getExistingIframe();return e||this.iFrameService.addIFrameToWindowBody(Q)},t.prototype.isSilentRenewConfigured=function(){return!this.configurationProvider.openIDConfiguration.useRefreshToken&&this.configurationProvider.openIDConfiguration.silentRenew},t.prototype.codeFlowCallbackSilentRenewIframe=function(t){var n=this,o=new r.HttpParams({fromString:t[1]}),a=o.get("error");if(a)return this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:e.ValidationResult.LoginRequired,isRenewProcess:!0}),this.flowsService.resetAuthorizationData(),this.flowsDataService.setNonce(""),this.intervallService.stopPeriodicallTokenCheck(),i.throwError(a);var c={code:o.get("code"),refreshToken:null,state:o.get("state"),sessionState:o.get("session_state"),authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:null};return this.flowsService.processSilentRenewCodeFlowCallback(c).pipe(s.catchError((function(e){return n.intervallService.stopPeriodicallTokenCheck(),n.flowsService.resetAuthorizationData(),i.throwError(e)})))},t.prototype.silentRenewEventHandler=function(e){var t=this;if(this.loggerService.logDebug("silentRenewEventHandler"),e.detail){var n=e.detail.toString().split("?"),o=new r.HttpParams({fromString:n[1]}).get("state"),s=this.flowsDataService.getAuthStateControl();o!==s&&this.loggerService.logError("silentRenewEventHandler > states don't match stateFromUrl: "+o+" currentState: "+s),this.tabsSynchronizationService.isLeaderCheck().then((function(r){if(r){i.of(null);(t.flowHelper.isCurrentFlowCodeFlow()?t.codeFlowCallbackSilentRenewIframe(n):t.implicitFlowCallbackService.authorizedImplicitFlowCallback(e.detail)).subscribe((function(e){t.refreshSessionWithIFrameCompletedInternal$.next(e),t.flowsDataService.resetSilentRenewRunning(),t.tabsSynchronizationService.sendSilentRenewFinishedNotification()}),(function(e){t.loggerService.logError("Error: "+e),t.refreshSessionWithIFrameCompletedInternal$.next(null),t.flowsDataService.resetSilentRenewRunning()}))}}))}},t.prototype.getExistingIframe=function(){return this.iFrameService.getExistingIFrame(Q)},t}();X.ɵfac=function(e){return new(e||X)(n.ɵɵinject(S),n.ɵɵinject(P),n.ɵɵinject(J),n.ɵɵinject(_),n.ɵɵinject(D),n.ɵɵinject(b),n.ɵɵinject(C),n.ɵɵinject(Y),n.ɵɵinject(G),n.ɵɵinject(Z))},X.ɵprov=n.ɵɵdefineInjectable({token:X,factory:X.ɵfac});var ee=function(){function e(e,t,r,n,i){this.flowsService=e,this.flowsDataService=t,this.intervallService=r,this.configurationProvider=n,this.router=i}return e.prototype.authorizedCallbackWithCode=function(e){var t=this,r=this.flowsDataService.isSilentRenewRunning();return this.flowsService.processCodeFlowCallback(e).pipe(s.tap((function(e){t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||e.isRenewProcess||t.router.navigate([t.configurationProvider.openIDConfiguration.postLoginRoute])})),s.catchError((function(e){return t.flowsDataService.resetSilentRenewRunning(),t.intervallService.stopPeriodicallTokenCheck(),t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||r||t.router.navigate([t.configurationProvider.openIDConfiguration.unauthorizedRoute]),i.throwError(e)})))},e}();ee.ɵfac=function(e){return new(e||ee)(n.ɵɵinject(J),n.ɵɵinject(_),n.ɵɵinject(G),n.ɵɵinject(S),n.ɵɵinject(c.Router))},ee.ɵprov=n.ɵɵdefineInjectable({token:ee,factory:ee.ɵfac,providedIn:"root"});var te=function(){function e(e,t,r,n){this.urlService=e,this.flowHelper=t,this.implicitFlowCallbackService=r,this.codeFlowCallbackService=n,this.stsCallbackInternal$=new i.Subject}return Object.defineProperty(e.prototype,"stsCallback$",{get:function(){return this.stsCallbackInternal$.asObservable()},enumerable:!1,configurable:!0}),e.prototype.isCallback=function(e){return this.urlService.isCallbackFromSts(e)},e.prototype.handleCallbackAndFireEvents=function(e){var t,r=this;return this.flowHelper.isCurrentFlowCodeFlow()?t=this.codeFlowCallbackService.authorizedCallbackWithCode(e):this.flowHelper.isCurrentFlowAnyImplicitFlow()&&(t=this.implicitFlowCallbackService.authorizedImplicitFlowCallback()),t.pipe(s.tap((function(){return r.stsCallbackInternal$.next()})))},e}();te.ɵfac=function(e){return new(e||te)(n.ɵɵinject(N),n.ɵɵinject(C),n.ɵɵinject(Y),n.ɵɵinject(ee))},te.ɵprov=n.ɵɵdefineInjectable({token:te,factory:te.ɵfac,providedIn:"root"});var re="/.well-known/openid-configuration",ne=function(){function e(e){this.http=e}return e.prototype.getWellKnownEndPointsFromUrl=function(e){return this.getWellKnownDocument(e).pipe(s.map((function(e){return{issuer:e.issuer,jwksUri:e.jwks_uri,authorizationEndpoint:e.authorization_endpoint,tokenEndpoint:e.token_endpoint,userinfoEndpoint:e.userinfo_endpoint,endSessionEndpoint:e.end_session_endpoint,checkSessionIframe:e.check_session_iframe,revocationEndpoint:e.revocation_endpoint,introspectionEndpoint:e.introspection_endpoint}})))},e.prototype.getWellKnownDocument=function(e){var t=e;return e.includes(re)||(t=""+e+re),this.http.get(t)},e}();ne.ɵfac=function(e){return new(e||ne)(n.ɵɵinject(d))},ne.ɵprov=n.ɵɵdefineInjectable({token:ne,factory:ne.ɵfac});var ie=function(){function t(e,t,r){this.publicEventsService=e,this.dataService=t,this.storagePersistanceService=r}return t.prototype.getAuthWellKnownEndPoints=function(t){var r=this,n=this.storagePersistanceService.read("authWellKnownEndPoints");return n?i.of(n):this.getWellKnownEndPointsFromUrl(t).pipe(s.tap((function(e){return r.storeWellKnownEndpoints(e)})),s.catchError((function(t){return r.publicEventsService.fireEvent(e.EventTypes.ConfigLoadingFailed,null),i.throwError(t)})))},t.prototype.storeWellKnownEndpoints=function(e){this.storagePersistanceService.write("authWellKnownEndPoints",e)},t.prototype.getWellKnownEndPointsFromUrl=function(e){return this.dataService.getWellKnownEndPointsFromUrl(e)},t}();ie.ɵfac=function(e){return new(e||ie)(n.ɵɵinject(m),n.ɵɵinject(ne),n.ɵɵinject(w))},ie.ɵprov=n.ɵɵdefineInjectable({token:ie,factory:ie.ɵfac});var oe=function(){function e(e,t,r,n,i){this.doc=e,this.loggerService=t,this.urlService=r,this.silentRenewService=n,this.renderer=i.createRenderer(null,null)}return e.prototype.refreshSessionWithIframe=function(e){this.loggerService.logDebug("BEGIN refresh session Authorize Iframe renew");var t=this.urlService.getRefreshSessionSilentRenewUrl(e);return this.sendAuthorizeReqestUsingSilentRenew(t)},e.prototype.sendAuthorizeReqestUsingSilentRenew=function(e){var t=this,r=this.silentRenewService.getOrCreateIframe();return this.initSilentRenewRequest(),this.loggerService.logDebug("sendAuthorizeReqestUsingSilentRenew for URL:"+e),new i.Observable((function(n){var i=function(){r.removeEventListener("load",i),t.loggerService.logDebug("removed event listener from IFrame"),n.next(!0),n.complete()};r.addEventListener("load",i),r.contentWindow.location.replace(e)}))},e.prototype.initSilentRenewRequest=function(){var e=this,t=Math.random(),r=this.renderer.listen("window","oidc-silent-renew-init",(function(e){e.detail!==t&&(r(),n())})),n=this.renderer.listen("window","oidc-silent-renew-message",(function(t){return e.silentRenewService.silentRenewEventHandler(t)}));this.doc.defaultView.dispatchEvent(new CustomEvent("oidc-silent-renew-init",{detail:t}))},e}();oe.ɵfac=function(e){return new(e||oe)(n.ɵɵinject(t.DOCUMENT),n.ɵɵinject(b),n.ɵɵinject(N),n.ɵɵinject(X),n.ɵɵinject(n.RendererFactory2))},oe.ɵprov=n.ɵɵdefineInjectable({token:oe,factory:oe.ɵfac,providedIn:"root"});var se=function(){function e(e,t,r){this.loggerService=e,this.flowsService=t,this.intervallService=r}return e.prototype.refreshSessionWithRefreshTokens=function(e){var t=this;return this.loggerService.logDebug("BEGIN refresh session Authorize"),this.flowsService.processRefreshToken(e).pipe(s.catchError((function(e){return t.intervallService.stopPeriodicallTokenCheck(),t.flowsService.resetAuthorizationData(),i.throwError(e)})))},e}();se.ɵfac=function(e){return new(e||se)(n.ɵɵinject(b),n.ɵɵinject(J),n.ɵɵinject(G))},se.ɵprov=n.ɵɵdefineInjectable({token:se,factory:se.ɵfac,providedIn:"root"});var ae=function(){function e(e,t,r,n,i,o,s,a,c,l){this.flowHelper=e,this.configurationProvider=t,this.flowsDataService=r,this.loggerService=n,this.silentRenewService=i,this.authStateService=o,this.authWellKnownService=s,this.refreshSessionIframeService=a,this.refreshSessionRefreshTokenService=c,this.tabsSynchronizationService=l}return e.prototype.forceRefreshSession=function(e){var t=this;return this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens()?this.startRefreshSession(e).pipe(s.map((function(){return t.authStateService.areAuthStorageTokensValid()?{idToken:t.authStateService.getIdToken(),accessToken:t.authStateService.getAccessToken()}:null}))):this.silentRenewCase()},e.prototype.silentRenewCase=function(e,t){var r=this;return this.loggerService.logDebug("silentRenewCase CURRENT RETRY ATTEMPT #"+t),t&&t>3?i.throwError(new Error("Initializatin has been failed. Exceeded max retry attepmts.")):i.from(this.tabsSynchronizationService.isLeaderCheck()).pipe(s.take(1),s.switchMap((function(n){return n?(r.loggerService.logDebug("forceRefreshSession WE ARE LEADER"),i.forkJoin([r.startRefreshSession(e),r.silentRenewService.refreshSessionWithIFrameCompleted$.pipe(s.take(1))]).pipe(s.timeout(1e3*r.configurationProvider.openIDConfiguration.silentRenewTimeoutInSeconds),s.map((function(e){var t,n,i=y(e,2),o=(i[0],i[1]);return r.authStateService.areAuthStorageTokensValid()?{idToken:null===(t=null==o?void 0:o.authResult)||void 0===t?void 0:t.id_token,accessToken:null===(n=null==o?void 0:o.authResult)||void 0===n?void 0:n.access_token}:null})),s.catchError((function(n){if(n instanceof i.TimeoutError)return r.loggerService.logWarning("forceRefreshSession WE ARE LEADER > occured TIMEOUT ERROR SO WE RETRY: this.forceRefreshSession(customParams)"),t?t++:t=1,r.silentRenewCase(e,t);throw n})))):(r.loggerService.logDebug("forceRefreshSession WE ARE NOT NOT NOT LEADER"),r.tabsSynchronizationService.getSilentRenewFinishedObservable().pipe(s.take(1),s.timeout(1e3*r.configurationProvider.openIDConfiguration.silentRenewTimeoutInSeconds),s.catchError((function(n){if(n instanceof i.TimeoutError)return r.loggerService.logWarning("forceRefreshSession WE ARE NOT NOT NOT LEADER > occured TIMEOUT ERROR SO WE RETRY: this.forceRefreshSession(customParams)"),t?t++:t=1,r.silentRenewCase(e,t);throw n})),s.map((function(){var e=r.authStateService.areAuthStorageTokensValid();return r.loggerService.logDebug("forceRefreshSession WE ARE NOT NOT NOT LEADER > getSilentRenewFinishedObservable EMMITS VALUE > isAuthenticated = "+e),e?{idToken:r.authStateService.getIdToken(),accessToken:r.authStateService.getAccessToken()}:(r.loggerService.logError("forceRefreshSession WE ARE NOT NOT NOT LEADER > getSilentRenewFinishedObservable EMMITS VALUE > isAuthenticated FALSE WE DONT KNOW WAHT TO DO WITH THIS"),null)}))))})))},e.prototype.startRefreshSession=function(e){var t,r=this,n=this.flowsDataService.isSilentRenewRunning();if(this.loggerService.logDebug("Checking: silentRenewRunning: "+n),!!n)return i.of(null);var o=null===(t=this.configurationProvider.openIDConfiguration)||void 0===t?void 0:t.authWellknownEndpoint;return o?this.authWellKnownService.getAuthWellKnownEndPoints(o).pipe(s.switchMap((function(){return r.flowsDataService.setSilentRenewRunning(),r.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens()?r.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(e):r.refreshSessionIframeService.refreshSessionWithIframe(e)}))):(this.loggerService.logError("no authwellknownendpoint given!"),i.of(null))},e}();ae.ɵfac=function(e){return new(e||ae)(n.ɵɵinject(C),n.ɵɵinject(S),n.ɵɵinject(_),n.ɵɵinject(b),n.ɵɵinject(X),n.ɵɵinject(D),n.ɵɵinject(ie),n.ɵɵinject(oe),n.ɵɵinject(se),n.ɵɵinject(Z))},ae.ɵprov=n.ɵɵdefineInjectable({token:ae,factory:ae.ɵfac,providedIn:"root"});var ce=function(){function e(e,t,r,n,i,o,s,a,c,l,u,h){this.flowsService=e,this.flowHelper=t,this.configurationProvider=r,this.flowsDataService=n,this.loggerService=i,this.userService=o,this.authStateService=s,this.refreshSessionIframeService=a,this.refreshSessionRefreshTokenService=c,this.intervalService=l,this.storagePersistanceService=u,this.tabsSynchronizationService=h}return e.prototype.startTokenValidationPeriodically=function(e){var t=this;if(!this.intervalService.runTokenValidationRunning&&this.configurationProvider.openIDConfiguration.silentRenew){this.loggerService.logDebug("starting token validation check every "+e+"s");var r=this.intervalService.startPeriodicTokenCheck(e).pipe(s.switchMap((function(){var e=t.authStateService.getIdToken(),r=t.flowsDataService.isSilentRenewRunning(),n=t.userService.getUserDataFromStore();if(t.loggerService.logDebug("Checking: silentRenewRunning: "+r+" id_token: "+!!e+" userData: "+!!n),!(n&&!r&&e))return i.of(null);var o=t.authStateService.hasIdTokenExpired(),a=t.authStateService.hasAccessTokenExpiredIfExpiryExists();return o||a?t.configurationProvider.openIDConfiguration.silentRenew?(t.loggerService.logDebug("starting silent renew..."),i.from(t.tabsSynchronizationService.isLeaderCheck()).pipe(s.take(1),s.switchMap((function(e){if(e&&!t.flowsDataService.isSilentRenewRunning()){t.flowsDataService.setSilentRenewRunning();var r=t.storagePersistanceService.read("storageCustomRequestParams");return t.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens()?t.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(r):t.refreshSessionIframeService.refreshSessionWithIframe(r)}return i.of(null)})))):(t.flowsService.resetAuthorizationData(),i.of(null)):i.of(null)})));this.intervalService.runTokenValidationRunning=r.pipe(s.catchError((function(){return t.flowsDataService.resetSilentRenewRunning(),i.throwError("periodically check failed")}))).subscribe((function(){t.loggerService.logDebug("silent renew, periodic check finished!"),t.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens()&&t.flowsDataService.resetSilentRenewRunning()}),(function(e){t.loggerService.logError("silent renew failed!",e)}))}},e}();ce.ɵfac=function(e){return new(e||ce)(n.ɵɵinject(J),n.ɵɵinject(C),n.ɵɵinject(S),n.ɵɵinject(_),n.ɵɵinject(b),n.ɵɵinject(K),n.ɵɵinject(D),n.ɵɵinject(oe),n.ɵɵinject(se),n.ɵɵinject(G),n.ɵɵinject(w),n.ɵɵinject(Z))},ce.ɵprov=n.ɵɵdefineInjectable({token:ce,factory:ce.ɵfac,providedIn:"root"});var le=function(){function e(){this.receivedUrlInternal$=new i.Subject}return Object.defineProperty(e.prototype,"receivedUrl$",{get:function(){return this.receivedUrlInternal$.asObservable()},enumerable:!1,configurable:!0}),e.prototype.isCurrentlyInPopup=function(){return!!window.opener&&window.opener!==window},e.prototype.openPopUp=function(e,t){var r=this,n=this.getOptions(t);this.popUp=window.open(e,"_blank",n);var i=function(e){(null==e?void 0:e.data)&&"string"==typeof e.data&&(r.receivedUrlInternal$.next(e.data),r.cleanUp(i))};window.addEventListener("message",i,!1)},e.prototype.sendMessageToMainWindow=function(e){window.opener&&this.sendMessage(e,window.location.href)},e.prototype.cleanUp=function(e){window.removeEventListener("message",e,!1),this.popUp&&(this.popUp.close(),this.popUp=null)},e.prototype.sendMessage=function(e,t){window.opener.postMessage(e,t)},e.prototype.getOptions=function(e){var t=Object.assign(Object.assign({},{width:500,height:500,left:50,top:50}),e||{});return Object.entries(t).map((function(e){var t=y(e,2),r=t[0],n=t[1];return encodeURIComponent(r)+"="+encodeURIComponent(n)})).join(",")},e}();le.ɵfac=function(e){return new(e||le)},le.ɵprov=n.ɵɵdefineInjectable({token:le,factory:le.ɵfac,providedIn:"root"});var ue=function(){function e(e,t,r,n,i,o,s,a,c,l,u){this.doc=e,this.checkSessionService=t,this.silentRenewService=r,this.userService=n,this.loggerService=i,this.configurationProvider=o,this.authStateService=s,this.callbackService=a,this.refreshSessionService=c,this.periodicallyTokenCheckService=l,this.popupService=u}return e.prototype.checkAuth=function(e){var t=this;if(!this.configurationProvider.hasValidConfig())return this.loggerService.logError("Please provide a configuration before setting up the module"),i.of(!1);this.loggerService.logDebug("STS server: "+this.configurationProvider.openIDConfiguration.stsServer);var r=e||this.doc.defaultView.location.toString();if(this.popupService.isCurrentlyInPopup())return this.popupService.sendMessageToMainWindow(r),i.of(null);var n=this.callbackService.isCallback(r);return this.loggerService.logDebug("currentUrl to check auth with: ",r),(n?this.callbackService.handleCallbackAndFireEvents(r):i.of(null)).pipe(s.map((function(){var e=t.authStateService.areAuthStorageTokensValid();return e&&(t.startCheckSessionAndValidation(),n||(t.authStateService.setAuthorizedAndFireEvent(),t.userService.publishUserDataIfExists())),t.loggerService.logDebug("checkAuth completed fired events, auth: "+e),e})),s.catchError((function(){return i.of(!1)})))},e.prototype.checkAuthIncludingServer=function(){var e=this;return this.checkAuth().pipe(s.switchMap((function(t){return t?i.of(t):e.refreshSessionService.forceRefreshSession().pipe(s.map((function(e){return!!(null==e?void 0:e.idToken)&&!!(null==e?void 0:e.accessToken)})),s.switchMap((function(t){return t&&e.startCheckSessionAndValidation(),i.of(t)})))})))},e.prototype.startCheckSessionAndValidation=function(){this.checkSessionService.isCheckSessionConfigured()&&this.checkSessionService.start(),this.periodicallyTokenCheckService.startTokenValidationPeriodically(this.configurationProvider.openIDConfiguration.tokenRefreshInSeconds),this.silentRenewService.isSilentRenewConfigured()&&this.silentRenewService.getOrCreateIframe()},e}();ue.ɵfac=function(e){return new(e||ue)(n.ɵɵinject(t.DOCUMENT),n.ɵɵinject(U),n.ɵɵinject(X),n.ɵɵinject(K),n.ɵɵinject(b),n.ɵɵinject(S),n.ɵɵinject(D),n.ɵɵinject(te),n.ɵɵinject(ae),n.ɵɵinject(ce),n.ɵɵinject(le))},ue.ɵprov=n.ɵɵdefineInjectable({token:ue,factory:ue.ɵfac});var he={result:!0,messages:[],level:null},de=[function(e){return e.stsServer?he:{result:!1,messages:["The STS URL MUST be provided in the configuration!"],level:"error"}},function(e){var t=e.useRefreshToken,r=e.silentRenew,n=(e.scope||"").split(" ").includes("offline_access");return t&&r&&!n?{result:!1,messages:["When using silent renew and refresh tokens please set the `offline_access` scope"],level:"error"}:he},function(e){return e.redirectUrl?he:{result:!1,messages:["The redirectURL is required and missing from your config"],level:"error"}},function(e){return e.clientId?he:{result:!1,messages:["The clientId is required and missing from your config!"],level:"error"}},function(e){var t=e.silentRenew,r=e.useRefreshToken,n=e.silentRenewUrl;return!t||r||n?he:{result:!1,messages:["Please provide a silent renew URL if using renew and not refresh tokens"],level:"error"}}],ge=function(){function e(e){this.loggerService=e}return e.prototype.validateConfig=function(e){var t=this,r=de.map((function(t){return t(e)})).filter((function(e){return e.messages.length>0})),n=this.getAllMessagesOfType("error",r),i=this.getAllMessagesOfType("warning",r);return n.map((function(e){return t.loggerService.logError(e)})),i.map((function(e){return t.loggerService.logWarning(e)})),0===n.length},e.prototype.getAllMessagesOfType=function(e,t){return t.filter((function(t){return t.level===e})).map((function(e){return e.messages})).reduce((function(e,t){return e.concat(t)}),[])},e}();ge.ɵfac=function(e){return new(e||ge)(n.ɵɵinject(b))},ge.ɵprov=n.ɵɵdefineInjectable({token:ge,factory:ge.ɵfac});var fe=function(){function t(e,t,r,n,i,o){this.loggerService=e,this.publicEventsService=t,this.configurationProvider=r,this.authWellKnownService=n,this.storagePersistanceService=i,this.configValidationService=o}return t.prototype.withConfig=function(t,r){var n=this;return new Promise((function(o,a){n.configValidationService.validateConfig(t)||(n.loggerService.logError("Validation of config rejected with errors. Config is NOT set."),o()),t.authWellknownEndpoint||(t.authWellknownEndpoint=t.stsServer);var c=n.configurationProvider.setConfig(t),l=n.storagePersistanceService.read("authWellKnownEndPoints");l&&(n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:l}),o()),r&&(n.authWellKnownService.storeWellKnownEndpoints(r),n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:r}),o()),c.eagerLoadAuthWellKnownEndpoints?n.authWellKnownService.getAuthWellKnownEndPoints(c.authWellknownEndpoint).pipe(s.catchError((function(e){return n.loggerService.logError("Getting auth well known endpoints failed on start",e),i.throwError(e)})),s.tap((function(r){return n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:r})}))).subscribe((function(){return o()}),(function(){return a()})):(n.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{configuration:t,wellknown:null}),o())}))},t}();fe.ɵfac=function(e){return new(e||fe)(n.ɵɵinject(b),n.ɵɵinject(m),n.ɵɵinject(S),n.ɵɵinject(ie),n.ɵɵinject(w),n.ɵɵinject(ge))},fe.ɵprov=n.ɵɵdefineInjectable({token:fe,factory:fe.ɵfac});var ve=function(){function e(e){this.doc=e}return e.prototype.redirectTo=function(e){this.doc.location.href=e},e}();ve.ɵfac=function(e){return new(e||ve)(n.ɵɵinject(t.DOCUMENT))},ve.ɵprov=n.ɵɵdefineInjectable({token:ve,factory:ve.ɵfac,providedIn:"root"});var pe=function(){function e(e,t,r,n,i,o,s,a,c,l){this.loggerService=e,this.tokenValidationService=t,this.urlService=r,this.redirectService=n,this.configurationProvider=i,this.authWellKnownService=o,this.popupService=s,this.checkAuthService=a,this.userService=c,this.authStateService=l}return e.prototype.login=function(e){var t=this;if(this.tokenValidationService.hasConfigValidResponseType()){var r=this.configurationProvider.openIDConfiguration.authWellknownEndpoint;r?(this.loggerService.logDebug("BEGIN Authorize OIDC Flow, no auth data"),this.authWellKnownService.getAuthWellKnownEndPoints(r).subscribe((function(){var r=e||{},n=r.urlHandler,i=r.customParams,o=t.urlService.getAuthorizeUrl(i);o?n?n(o):t.redirectService.redirectTo(o):t.loggerService.logError("Could not create url",o)}))):this.loggerService.logError("no authWellknownEndpoint given!")}else this.loggerService.logError("Invalid response type!")},e.prototype.loginWithPopUp=function(e,t){var r=this;if(this.tokenValidationService.hasConfigValidResponseType()){var n=this.configurationProvider.openIDConfiguration.authWellknownEndpoint;if(n)return this.loggerService.logDebug("BEGIN Authorize OIDC Flow with popup, no auth data"),this.authWellKnownService.getAuthWellKnownEndPoints(n).pipe(s.switchMap((function(){var n=(e||{}).customParams,i=r.urlService.getAuthorizeUrl(n);return r.popupService.openPopUp(i,t),r.popupService.receivedUrl$.pipe(s.switchMap((function(e){return r.checkAuthService.checkAuth(e)})),s.map((function(e){return{isAuthenticated:e,userData:r.userService.getUserDataFromStore(),accessToken:r.authStateService.getAccessToken()}})))})));this.loggerService.logError("no authWellknownEndpoint given!")}else this.loggerService.logError("Invalid response type!")},e}();pe.ɵfac=function(e){return new(e||pe)(n.ɵɵinject(b),n.ɵɵinject(T),n.ɵɵinject(N),n.ɵɵinject(ve),n.ɵɵinject(S),n.ɵɵinject(ie),n.ɵɵinject(le),n.ɵɵinject(ue),n.ɵɵinject(K),n.ɵɵinject(D))},pe.ɵprov=n.ɵɵdefineInjectable({token:pe,factory:pe.ɵfac});var Se=function(){function e(e,t,r,n,i,o,s){this.dataService=e,this.storagePersistanceService=t,this.loggerService=r,this.urlService=n,this.checkSessionService=i,this.flowsService=o,this.redirectService=s}return e.prototype.logoff=function(e){this.loggerService.logDebug("logoff, remove auth ");var t=this.getEndSessionUrl();this.flowsService.resetAuthorizationData(),t?this.checkSessionService.serverStateChanged()?this.loggerService.logDebug("only local login cleaned up, server session has changed"):e?e(t):this.redirectService.redirectTo(t):this.loggerService.logDebug("only local login cleaned up, no end_session_endpoint")},e.prototype.logoffLocal=function(){this.flowsService.resetAuthorizationData()},e.prototype.logoffAndRevokeTokens=function(e){var t,r=this;return(null===(t=this.storagePersistanceService.read("authWellKnownEndPoints"))||void 0===t?void 0:t.revocationEndpoint)||(this.loggerService.logDebug("revocation endpoint not supported"),this.logoff(e)),this.storagePersistanceService.getRefreshToken()?this.revokeRefreshToken().pipe(s.switchMap((function(e){return r.revokeAccessToken(e)})),s.catchError((function(e){var t="revoke token failed";return r.loggerService.logError(t,e),i.throwError(t)})),s.tap((function(){return r.logoff(e)}))):this.revokeAccessToken().pipe(s.catchError((function(e){var t="revoke access token failed";return r.loggerService.logError(t,e),i.throwError(t)})),s.tap((function(){return r.logoff(e)})))},e.prototype.revokeAccessToken=function(e){var t=this,n=e||this.storagePersistanceService.getAccessToken(),o=this.urlService.createRevocationEndpointBodyAccessToken(n),a=this.urlService.getRevocationEndpointUrl(),c=new r.HttpHeaders;return c=c.set("Content-Type","application/x-www-form-urlencoded"),this.dataService.post(a,o,c).pipe(s.switchMap((function(e){return t.loggerService.logDebug("revocation endpoint post response: ",e),i.of(e)})),s.catchError((function(e){var r="Revocation request failed";return t.loggerService.logError(r,e),i.throwError(r)})))},e.prototype.revokeRefreshToken=function(e){var t=this,n=e||this.storagePersistanceService.getRefreshToken(),o=this.urlService.createRevocationEndpointBodyRefreshToken(n),a=this.urlService.getRevocationEndpointUrl(),c=new r.HttpHeaders;return c=c.set("Content-Type","application/x-www-form-urlencoded"),this.dataService.post(a,o,c).pipe(s.switchMap((function(e){return t.loggerService.logDebug("revocation endpoint post response: ",e),i.of(e)})),s.catchError((function(e){var r="Revocation request failed";return t.loggerService.logError(r,e),i.throwError(r)})))},e.prototype.getEndSessionUrl=function(){var e=this.storagePersistanceService.getIdToken();return this.urlService.createEndSessionUrl(e)},e}();Se.ɵfac=function(e){return new(e||Se)(n.ɵɵinject(d),n.ɵɵinject(w),n.ɵɵinject(b),n.ɵɵinject(N),n.ɵɵinject(U),n.ɵɵinject(J),n.ɵɵinject(ve))},Se.ɵprov=n.ɵɵdefineInjectable({token:Se,factory:Se.ɵfac});var we=function(){function e(e,t,r,n,i,o,s,a,c,l,u,h){this.checkSessionService=e,this.checkAuthService=t,this.userService=r,this.tokenHelperService=n,this.configurationProvider=i,this.authStateService=o,this.flowsDataService=s,this.callbackService=a,this.logoffRevocationService=c,this.loginService=l,this.storagePersistanceService=u,this.refreshSessionService=h}return Object.defineProperty(e.prototype,"configuration",{get:function(){return{configuration:this.configurationProvider.openIDConfiguration,wellknown:this.storagePersistanceService.read("authWellKnownEndPoints")}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userData$",{get:function(){return this.userService.userData$},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isAuthenticated$",{get:function(){return this.authStateService.authorized$},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"checkSessionChanged$",{get:function(){return this.checkSessionService.checkSessionChanged$},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stsCallback$",{get:function(){return this.callbackService.stsCallback$},enumerable:!1,configurable:!0}),e.prototype.checkAuth=function(e){return this.checkAuthService.checkAuth(e)},e.prototype.checkAuthIncludingServer=function(){return this.checkAuthService.checkAuthIncludingServer()},e.prototype.getToken=function(){return this.authStateService.getAccessToken()},e.prototype.getIdToken=function(){return this.authStateService.getIdToken()},e.prototype.getRefreshToken=function(){return this.authStateService.getRefreshToken()},e.prototype.getPayloadFromIdToken=function(e){void 0===e&&(e=!1);var t=this.getIdToken();return this.tokenHelperService.getPayloadFromToken(t,e)},e.prototype.setState=function(e){this.flowsDataService.setAuthStateControl(e)},e.prototype.getState=function(){return this.flowsDataService.getAuthStateControl()},e.prototype.authorize=function(e){(null==e?void 0:e.customParams)&&this.storagePersistanceService.write("storageCustomRequestParams",e.customParams),this.loginService.login(e)},e.prototype.authorizeWithPopUp=function(e){return(null==e?void 0:e.customParams)&&this.storagePersistanceService.write("storageCustomRequestParams",e.customParams),this.loginService.loginWithPopUp(e)},e.prototype.forceRefreshSession=function(e){return e&&this.storagePersistanceService.write("storageCustomRequestParams",e),this.refreshSessionService.forceRefreshSession(e)},e.prototype.logoffAndRevokeTokens=function(e){return this.logoffRevocationService.logoffAndRevokeTokens(e)},e.prototype.logoff=function(e){return this.logoffRevocationService.logoff(e)},e.prototype.logoffLocal=function(){return this.logoffRevocationService.logoffLocal()},e.prototype.revokeAccessToken=function(e){return this.logoffRevocationService.revokeAccessToken(e)},e.prototype.revokeRefreshToken=function(e){return this.logoffRevocationService.revokeRefreshToken(e)},e.prototype.getEndSessionUrl=function(){return this.logoffRevocationService.getEndSessionUrl()},e}();we.ɵfac=function(e){return new(e||we)(n.ɵɵinject(U),n.ɵɵinject(ue),n.ɵɵinject(K),n.ɵɵinject(E),n.ɵɵinject(S),n.ɵɵinject(D),n.ɵɵinject(_),n.ɵɵinject(te),n.ɵɵinject(Se),n.ɵɵinject(pe),n.ɵɵinject(w),n.ɵɵinject(ae))},we.ɵprov=n.ɵɵdefineInjectable({token:we,factory:we.ɵfac});var ke=function(){function e(e,t){this.configProvider=e,this.loggerService=t}return e.prototype.read=function(e){var t;if(!this.hasStorage())return this.loggerService.logDebug("Wanted to read '"+e+"' but Storage was undefined"),!1;var r=null===(t=this.getStorage())||void 0===t?void 0:t.getItem(e);return r?JSON.parse(r):(this.loggerService.logDebug("Wanted to read '"+e+"' but nothing was found"),null)},e.prototype.write=function(e,t){if(!this.hasStorage())return this.loggerService.logDebug("Wanted to write '"+e+"/"+t+"' but Storage was falsy"),!1;var r=this.getStorage();return r?(t=t||null,r.setItem(""+e,JSON.stringify(t)),!0):(this.loggerService.logDebug("Wanted to write '"+e+"/"+t+"' but Storage was falsy"),!1)},e.prototype.remove=function(e){if(!this.hasStorage())return this.loggerService.logDebug("Wanted to remove '"+e+"' but Storage was falsy"),!1;var t=this.getStorage();return t?(t.removeItem(""+e),!0):(this.loggerService.logDebug("Wanted to write '"+e+"' but Storage was falsy"),!1)},e.prototype.getStorage=function(){var e;return null===(e=this.configProvider.openIDConfiguration)||void 0===e?void 0:e.storage},e.prototype.hasStorage=function(){return"undefined"!=typeof Storage},e}();ke.ɵfac=function(e){return new(e||ke)(n.ɵɵinject(S),n.ɵɵinject(b))},ke.ɵprov=n.ɵɵdefineInjectable({token:ke,factory:ke.ɵfac});var ye=function(){function e(){}return e.forRoot=function(t){return void 0===t&&(t={}),{ngModule:e,providers:[fe,m,C,we,T,p,U,_,J,X,S,Se,K,O,u,N,D,M,w,E,b,P,B,pe,ne,ie,d,$,ge,ue,{provide:f,useClass:t.storage||ke},Z]}},e}();ye.ɵmod=n.ɵɵdefineNgModule({type:ye}),ye.ɵinj=n.ɵɵdefineInjector({factory:function(e){return new(e||ye)},imports:[[t.CommonModule,r.HttpClientModule]]}),("undefined"==typeof ngJitMode||ngJitMode)&&n.ɵɵsetNgModuleScope(ye,{imports:[t.CommonModule,r.HttpClientModule]});var Ie=function(){function e(e,t,r){this.authStateService=e,this.configurationProvider=t,this.loggerService=r}return e.prototype.intercept=function(e,t){var r=this.configurationProvider.openIDConfiguration.secureRoutes;if(!r)return this.loggerService.logDebug("No routes to check configured"),t.handle(e);var n=r.find((function(t){return e.url.startsWith(t)}));if(!n)return this.loggerService.logDebug("Did not find matching route for "+e.url),t.handle(e);this.loggerService.logDebug("'"+e.url+"' matches configured route '"+n+"'");var i=this.authStateService.getAccessToken();return i?(this.loggerService.logDebug("'"+e.url+"' matches configured route '"+n+"', adding token"),e=e.clone({headers:e.headers.set("Authorization","Bearer "+i)}),t.handle(e)):(this.loggerService.logDebug("Wanted to add token to "+e.url+" but found no token: '"+i+"'"),t.handle(e))},e}();Ie.ɵfac=function(e){return new(e||Ie)(n.ɵɵinject(D),n.ɵɵinject(S),n.ɵɵinject(b))},Ie.ɵprov=n.ɵɵdefineInjectable({token:Ie,factory:Ie.ɵfac});var Re=function(){this.keys=[]},be=function(){this.kty="",this.use="",this.kid="",this.x5t="",this.e="",this.n="",this.x5c=[]};e.AbstractSecurityStorage=f,e.AuthInterceptor=Ie,e.AuthModule=ye,e.JwtKey=be,e.JwtKeys=Re,e.LoggerService=b,e.OidcConfigService=fe,e.OidcSecurityService=we,e.PublicEventsService=m,e.StateValidationResult=q,e.TokenHelperService=E,e.TokenValidationService=T,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-auth-oidc-client.umd.min.js.map